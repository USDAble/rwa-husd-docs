# 02 - Geth æ¶æ„ (Geth Architecture)

**éš¾åº¦**: â­â­â˜†â˜†â˜† | **é¢„ä¼°å­¦ä¹ æ—¶é—´**: 10-12 å°æ—¶

---

## ğŸ“‹ æœ¬ç« æ¦‚è¿°

æœ¬ç« å°†æ·±å…¥ä»‹ç» Go-Ethereum (Geth) å®¢æˆ·ç«¯çš„æ¶æ„è®¾è®¡,åŒ…æ‹¬æ ¸å¿ƒç»„ä»¶ã€æ•°æ®å­˜å‚¨ã€P2P ç½‘ç»œå’Œæ‰§è¡Œå±‚ä¸å…±è¯†å±‚çš„äº¤äº’æœºåˆ¶ã€‚

### å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬ç« å­¦ä¹ å,æ‚¨å°†èƒ½å¤Ÿ:

- ç†è§£ Geth å®¢æˆ·ç«¯çš„æ•´ä½“æ¶æ„
- æŒæ¡ Geth çš„æ ¸å¿ƒç»„ä»¶å’ŒèŒè´£
- ç†è§£æ•°æ®åº“å’Œå­˜å‚¨æœºåˆ¶
- äº†è§£æ‰§è¡Œå±‚ä¸å…±è¯†å±‚çš„äº¤äº’
- æŒæ¡ Geth çš„å¯åŠ¨æµç¨‹

---

## 1. Geth å®¢æˆ·ç«¯æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯ Geth?

**Go-Ethereum (Geth)** æ˜¯ä»¥å¤ªåŠå®˜æ–¹çš„ Go è¯­è¨€å®ç°,æ˜¯æœ€æµè¡Œçš„ä»¥å¤ªåŠæ‰§è¡Œå±‚å®¢æˆ·ç«¯ã€‚

**æ ¸å¿ƒç‰¹æ€§**:
- **æ‰§è¡Œå±‚å®¢æˆ·ç«¯**: è´Ÿè´£äº¤æ˜“æ‰§è¡Œå’ŒçŠ¶æ€ç®¡ç†
- **EVM å®ç°**: å®Œæ•´çš„ä»¥å¤ªåŠè™šæ‹Ÿæœº
- **P2P ç½‘ç»œ**: devp2p åè®®å®ç°
- **JSON-RPC API**: æ ‡å‡†çš„ä»¥å¤ªåŠ API
- **é«˜æ€§èƒ½**: Go è¯­è¨€å®ç°,å¹¶å‘æ€§èƒ½ä¼˜ç§€

### 1.2 Geth åœ¨ä»¥å¤ªåŠç”Ÿæ€ä¸­çš„è§’è‰²

```plaintext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä»¥å¤ªåŠç½‘ç»œ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   å…±è¯†å±‚å®¢æˆ·ç«¯    â”‚         â”‚   å…±è¯†å±‚å®¢æˆ·ç«¯    â”‚        â”‚
â”‚  â”‚  (Prysm/Lighthouse)â”‚ â—„â”€â”€â–º â”‚  (Prysm/Lighthouse)â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚           â”‚ Engine API                â”‚ Engine API      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   æ‰§è¡Œå±‚å®¢æˆ·ç«¯    â”‚         â”‚   æ‰§è¡Œå±‚å®¢æˆ·ç«¯    â”‚        â”‚
â”‚  â”‚     (Geth)      â”‚ â—„â”€â”€â–º â”‚     (Geth)      â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  P2P   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 Geth ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | å‘å¸ƒæ—¶é—´ | ä¸»è¦ç‰¹æ€§ |
|------|----------|----------|
| **v1.0.0** | 2015.07 | Frontier ä¸»ç½‘å¯åŠ¨ |
| **v1.5.0** | 2016.09 | å¼•å…¥ Whisper åè®® |
| **v1.8.0** | 2018.02 | å¼•å…¥ Puppeth å·¥å…· |
| **v1.10.0** | 2021.03 | Snap Sync åŒæ­¥æ¨¡å¼ |
| **v1.11.0** | 2022.09 | The Merge æ”¯æŒ |
| **v1.13.0** | 2023.09 | Path-based å­˜å‚¨æ–¹æ¡ˆ |

---

## 2. Geth æ•´ä½“æ¶æ„

### 2.1 æ¶æ„åˆ†å±‚

```plaintext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨å±‚ (Application)                   â”‚
â”‚  - Geth Console (JavaScript)                            â”‚
â”‚  - JSON-RPC Server (HTTP/WebSocket/IPC)                 â”‚
â”‚  - GraphQL Server                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–²
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ ¸å¿ƒå±‚ (Core)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   EVM    â”‚  â”‚ Tx Pool  â”‚  â”‚  Miner   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ Blockchainâ”‚  â”‚  State   â”‚  â”‚ Consensusâ”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–²
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å­˜å‚¨å±‚ (Storage)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  LevelDB/Pebble  â”‚  â”‚  Ancient Store   â”‚            â”‚
â”‚  â”‚  (Recent Data)   â”‚  â”‚  (Freezer)       â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–²
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç½‘ç»œå±‚ (Network)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  devp2p (P2P)    â”‚  â”‚  Engine API      â”‚            â”‚
â”‚  â”‚  - Node Discoveryâ”‚  â”‚  (Consensus)     â”‚            â”‚
â”‚  â”‚  - Block Sync    â”‚  â”‚                  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | èŒè´£ | å…³é”®åŠŸèƒ½ |
|------|------|----------|
| **EVM** | æ‰§è¡Œæ™ºèƒ½åˆçº¦ | æ“ä½œç æ‰§è¡Œã€Gas è®¡ç®—ã€çŠ¶æ€æ›´æ–° |
| **Transaction Pool** | ç®¡ç†å¾…å¤„ç†äº¤æ˜“ | äº¤æ˜“éªŒè¯ã€æ’åºã€å¹¿æ’­ |
| **Blockchain** | ç®¡ç†åŒºå—é“¾æ•°æ® | åŒºå—éªŒè¯ã€é“¾é‡ç»„ã€åˆ†å‰é€‰æ‹© |
| **State** | ç®¡ç†è´¦æˆ·çŠ¶æ€ | çŠ¶æ€æ ‘ã€å­˜å‚¨ã€å¿«ç…§ |
| **Consensus** | å…±è¯†æ¥å£ | Engine APIã€åŒºå—ç”Ÿäº§ |
| **P2P Network** | èŠ‚ç‚¹é€šä¿¡ | èŠ‚ç‚¹å‘ç°ã€åŒºå—åŒæ­¥ã€äº¤æ˜“å¹¿æ’­ |
| **Database** | æ•°æ®æŒä¹…åŒ– | LevelDB/Pebbleã€Ancient Store |

---

## 3. æ•°æ®åº“ä¸å­˜å‚¨

### 3.1 å­˜å‚¨æ¶æ„

Geth ä½¿ç”¨ä¸¤å±‚å­˜å‚¨æ¶æ„:

```plaintext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Key-Value Store (LevelDB/Pebble)            â”‚
â”‚  - æœ€è¿‘çš„åŒºå—å’ŒçŠ¶æ€ (~128 ä¸ªåŒºå—)                          â”‚
â”‚  - äº¤æ˜“ç´¢å¼•                                              â”‚
â”‚  - çŠ¶æ€æ ‘ (Trie)                                         â”‚
â”‚  - å¿«ç…§ (Snapshot)                                       â”‚
â”‚  å­˜å‚¨ä½ç½®: <datadir>/geth/chaindata/                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          +
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Ancient Store (Freezer)                     â”‚
â”‚  - å†å²åŒºå— (Headers, Bodies, Receipts)                  â”‚
â”‚  - å†å²çŠ¶æ€ (å¯é€‰,Archive æ¨¡å¼)                           â”‚
â”‚  - ä¸å¯å˜æ•°æ®,è¿½åŠ å†™å…¥                                    â”‚
â”‚  å­˜å‚¨ä½ç½®: <datadir>/geth/chaindata/ancient/             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ•°æ®åº“å¼•æ“

Geth æ”¯æŒä¸¤ç§æ•°æ®åº“å¼•æ“:

| å¼•æ“ | ç‰¹æ€§ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **LevelDB** | é»˜è®¤å¼•æ“,æˆç†Ÿç¨³å®š | é€šç”¨åœºæ™¯ |
| **Pebble** | æ›´å¥½çš„æ€§èƒ½,æ´»è·ƒç»´æŠ¤ | é«˜æ€§èƒ½éœ€æ±‚ |

**åˆ‡æ¢åˆ° Pebble**:

```bash
# éœ€è¦å…¨æ–°æ•°æ®ç›®å½•,æ— æ³•ä» LevelDB è¿ç§»
geth --db.engine=pebble --datadir /path/to/new/datadir
```

### 3.3 å­˜å‚¨æ–¹æ¡ˆ

Geth æ”¯æŒä¸¤ç§çŠ¶æ€å­˜å‚¨æ–¹æ¡ˆ:

#### Hash-based Scheme (ä¼ ç»Ÿæ–¹æ¡ˆ)

- ä½¿ç”¨ Merkle Patricia Trie
- èŠ‚ç‚¹ä»¥å“ˆå¸Œå€¼ä¸ºé”®å­˜å‚¨
- é€‚åˆéªŒè¯å’ŒåŒæ­¥

#### Path-based Scheme (æ–°æ–¹æ¡ˆ,v1.13+)

- ä½¿ç”¨è·¯å¾„ä½œä¸ºé”®
- æ›´é«˜æ•ˆçš„å­˜å‚¨å’Œè®¿é—®
- æ”¯æŒå†å²çŠ¶æ€ç´¢å¼•

**åˆå§‹åŒ– Path-based å­˜å‚¨**:

```bash
geth --state.scheme=path init --datadir data genesis.json
```

### 3.4 æ•°æ®ç›®å½•ç»“æ„

```plaintext
<datadir>/
â”œâ”€â”€ geth/
â”‚   â”œâ”€â”€ chaindata/              # ä¸»æ•°æ®åº“
â”‚   â”‚   â”œâ”€â”€ 000001.log          # LevelDB æ—¥å¿—æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ CURRENT             # å½“å‰æ•°æ®åº“ç‰ˆæœ¬
â”‚   â”‚   â”œâ”€â”€ LOCK                # æ•°æ®åº“é”æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ LOG                 # LevelDB æ—¥å¿—
â”‚   â”‚   â”œâ”€â”€ MANIFEST-000000     # æ•°æ®åº“æ¸…å•
â”‚   â”‚   â””â”€â”€ ancient/            # Freezer æ•°æ®åº“
â”‚   â”‚       â”œâ”€â”€ chain/          # åŒºå—é“¾æ•°æ®
â”‚   â”‚       â”‚   â”œâ”€â”€ bodies.0000.cdat
â”‚   â”‚       â”‚   â”œâ”€â”€ headers.0000.cdat
â”‚   â”‚       â”‚   â”œâ”€â”€ hashes.0000.cdat
â”‚   â”‚       â”‚   â””â”€â”€ receipts.0000.cdat
â”‚   â”‚       â””â”€â”€ state/          # å†å²çŠ¶æ€ (Archive æ¨¡å¼)
â”‚   â”œâ”€â”€ lightchaindata/         # Light å®¢æˆ·ç«¯æ•°æ®
â”‚   â”œâ”€â”€ nodes/                  # èŠ‚ç‚¹å‘ç°æ•°æ®
â”‚   â””â”€â”€ LOCK                    # Geth å®ä¾‹é”
â”œâ”€â”€ keystore/                   # è´¦æˆ·å¯†é’¥åº“
â”‚   â””â”€â”€ UTC--2023-...--address  # åŠ å¯†çš„ç§é’¥æ–‡ä»¶
â””â”€â”€ geth.ipc                    # IPC é€šä¿¡æ–‡ä»¶
```

### 3.5 æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡

Geth æä¾›è¯¦ç»†çš„æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡:

```plaintext
LevelDB Metrics:
  - compTimeMeter: å‹ç¼©æ€»æ—¶é—´
  - compReadMeter: å‹ç¼©è¯»å–æ•°æ®é‡
  - compWriteMeter: å‹ç¼©å†™å…¥æ•°æ®é‡
  - diskSizeGauge: æ•°æ®åº“æ€»å¤§å°
  - diskReadMeter: æœ‰æ•ˆè¯»å–æ•°æ®é‡
  - diskWriteMeter: æœ‰æ•ˆå†™å…¥æ•°æ®é‡

Freezer Metrics:
  - readMeter: è¯»å–æ•°æ®é‡
  - writeMeter: å†™å…¥æ•°æ®é‡
  - sizeGauge: Freezer æ€»å¤§å°
```

---

## 4. æ‰§è¡Œå±‚ä¸å…±è¯†å±‚äº¤äº’

### 4.1 Engine API

The Merge å,Geth é€šè¿‡ **Engine API** ä¸å…±è¯†å±‚å®¢æˆ·ç«¯é€šä¿¡ã€‚

**Engine API ç«¯ç‚¹**:

```plaintext
é»˜è®¤åœ°å€: http://localhost:8551
è®¤è¯æ–¹å¼: JWT (JSON Web Token)
åè®®: JSON-RPC over HTTP
```

**å¯åŠ¨ Geth å¹¶é…ç½® Engine API**:

```bash
geth \
  --authrpc.addr localhost \
  --authrpc.port 8551 \
  --authrpc.vhosts localhost \
  --authrpc.jwtsecret /path/to/jwtsecret
```

### 4.2 JWT è®¤è¯

Engine API ä½¿ç”¨ JWT è¿›è¡Œè®¤è¯:

**ç”Ÿæˆ JWT Secret**:

```bash
# ç”Ÿæˆ 32 å­—èŠ‚çš„éšæœºå¯†é’¥
openssl rand -hex 32 > jwtsecret
```

**JWT Secret æ ¼å¼**:

```plaintext
0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef
```

### 4.3 Engine API æ–¹æ³•

| æ–¹æ³• | æè¿° | è°ƒç”¨æ–¹ |
|------|------|--------|
| `engine_newPayloadV1` | æäº¤æ–°çš„æ‰§è¡Œè´Ÿè½½ | å…±è¯†å±‚ |
| `engine_forkchoiceUpdatedV1` | æ›´æ–°åˆ†å‰é€‰æ‹© | å…±è¯†å±‚ |
| `engine_getPayloadV1` | è·å–æ‰§è¡Œè´Ÿè½½ | å…±è¯†å±‚ |
| `engine_exchangeTransitionConfigurationV1` | äº¤æ¢é…ç½® | å…±è¯†å±‚ |

### 4.4 åŒºå—ç”Ÿäº§æµç¨‹

```mermaid
sequenceDiagram
    participant CL as å…±è¯†å±‚å®¢æˆ·ç«¯
    participant EL as Geth (æ‰§è¡Œå±‚)
    
    CL->>EL: engine_forkchoiceUpdatedV1(head, safe, finalized)
    EL-->>CL: payloadId
    
    CL->>EL: engine_getPayloadV1(payloadId)
    EL-->>CL: executionPayload (åŒºå—å†…å®¹)
    
    CL->>CL: ç­¾åå¹¶å¹¿æ’­åŒºå—
    
    CL->>EL: engine_newPayloadV1(executionPayload)
    EL-->>CL: status (VALID/INVALID)
    
    CL->>EL: engine_forkchoiceUpdatedV1(newHead)
    EL-->>CL: success
```

---

## 5. P2P ç½‘ç»œå±‚

### 5.1 devp2p åè®®

Geth ä½¿ç”¨ **devp2p** åè®®è¿›è¡ŒèŠ‚ç‚¹é—´é€šä¿¡ã€‚

**devp2p åè®®æ ˆ**:

```plaintext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      åº”ç”¨åè®® (eth, snap, les)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      RLPx (åŠ å¯†ä¼ è¾“å±‚)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      èŠ‚ç‚¹å‘ç° (Discovery v4/v5)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      ä¼ è¾“å±‚ (TCP/UDP)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 èŠ‚ç‚¹å‘ç°

**Discovery v4 (åŸºäº Kademlia DHT)**:

```plaintext
1. Bootstrap Nodes: è¿æ¥åˆ°é¢„é…ç½®çš„å¼•å¯¼èŠ‚ç‚¹
2. PING/PONG: æ£€æµ‹èŠ‚ç‚¹æ´»è·ƒæ€§
3. FIND_NODE: æŸ¥æ‰¾ç‰¹å®šè·ç¦»çš„èŠ‚ç‚¹
4. NEIGHBORS: è¿”å›é‚»è¿‘èŠ‚ç‚¹åˆ—è¡¨
```

**Discovery v5 (æ”¹è¿›ç‰ˆ)**:

- æ›´å¥½çš„éšç§ä¿æŠ¤
- æ”¯æŒ ENR (Ethereum Node Records)
- æ›´é«˜æ•ˆçš„èŠ‚ç‚¹å‘ç°

### 5.3 ä»¥å¤ªåŠå­åè®®

| åè®® | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **eth** | eth/66, eth/67, eth/68 | åŒºå—å’Œäº¤æ˜“åŒæ­¥ |
| **snap** | snap/1 | å¿«ç…§åŒæ­¥ |
| **les** | les/4 | è½»å®¢æˆ·ç«¯åè®® |

---

## 6. Geth å¯åŠ¨æµç¨‹

### 6.1 å¯åŠ¨æ­¥éª¤

```mermaid
graph TD
    A[å¯åŠ¨ Geth] --> B[è§£æå‘½ä»¤è¡Œå‚æ•°]
    B --> C[åŠ è½½é…ç½®æ–‡ä»¶]
    C --> D[åˆå§‹åŒ–æ•°æ®åº“]
    D --> E[åŠ è½½åˆ›ä¸–åŒºå—]
    E --> F[åˆå§‹åŒ– P2P ç½‘ç»œ]
    F --> G[å¯åŠ¨ Engine API]
    G --> H[å¯åŠ¨ JSON-RPC æœåŠ¡]
    H --> I[å¼€å§‹åŒºå—åŒæ­¥]
    I --> J[Geth è¿è¡Œä¸­]
```

### 6.2 å¯åŠ¨æ—¥å¿—è§£æ

**å…¸å‹çš„ Geth å¯åŠ¨æ—¥å¿—**:

```log
INFO [10-04|10:20:52.028] Starting Geth on Ethereum mainnet...
INFO [10-04|10:20:52.028] Bumping default cache on mainnet provided=1024 updated=4096
INFO [10-04|10:20:52.030] Maximum peer count ETH=50 LES=0 total=50
INFO [10-04|10:20:52.035] Allocated trie memory caches clean=614.00MiB dirty=1024.00MiB
INFO [10-04|10:20:52.035] Allocated cache and file handles database=/home/geth/chaindata cache=2.00GiB handles=524,288
INFO [10-04|10:20:52.128] Opened ancient database database=/home/geth/chaindata/ancient/chain readonly=false
INFO [10-04|10:20:52.386] Chain ID: 1 (mainnet)
INFO [10-04|10:20:52.386] Consensus: Beacon (proof-of-stake), merged from Ethash (proof-of-work)
```

**å…³é”®ä¿¡æ¯**:
- **Cache åˆ†é…**: Trie ç¼“å­˜ã€æ•°æ®åº“ç¼“å­˜
- **æ•°æ®åº“è·¯å¾„**: chaindata å’Œ ancient æ•°æ®åº“ä½ç½®
- **Chain ID**: ç½‘ç»œæ ‡è¯† (1 = Mainnet)
- **å…±è¯†æœºåˆ¶**: Beacon (PoS)

---

## 7. å®è·µç»ƒä¹ 

### ç»ƒä¹  1: æ£€æŸ¥ Geth æ•°æ®åº“

```bash
# æ£€æŸ¥æ•°æ®åº“å­˜å‚¨ä½¿ç”¨æƒ…å†µ
geth db inspect --datadir /path/to/datadir

# æŸ¥çœ‹æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
geth db stats --datadir /path/to/datadir
```

### ç»ƒä¹  2: é…ç½® Engine API

1. ç”Ÿæˆ JWT Secret
2. å¯åŠ¨ Geth å¹¶é…ç½® Engine API
3. éªŒè¯ Engine API ç«¯ç‚¹å¯è®¿é—®

### ç»ƒä¹  3: åˆ†æå¯åŠ¨æ—¥å¿—

1. å¯åŠ¨ Geth èŠ‚ç‚¹
2. åˆ†æå¯åŠ¨æ—¥å¿—ä¸­çš„å…³é”®ä¿¡æ¯
3. ç†è§£å„ä¸ªç»„ä»¶çš„åˆå§‹åŒ–é¡ºåº

---

## 8. æ€»ç»“

æœ¬ç« ä»‹ç»äº† Geth å®¢æˆ·ç«¯çš„æ¶æ„:

- âœ… **æ•´ä½“æ¶æ„**: åˆ†å±‚è®¾è®¡å’Œæ ¸å¿ƒç»„ä»¶
- âœ… **æ•°æ®åº“å­˜å‚¨**: LevelDB/Pebble å’Œ Ancient Store
- âœ… **Engine API**: æ‰§è¡Œå±‚ä¸å…±è¯†å±‚äº¤äº’
- âœ… **P2P ç½‘ç»œ**: devp2p åè®®å’ŒèŠ‚ç‚¹å‘ç°
- âœ… **å¯åŠ¨æµç¨‹**: Geth çš„åˆå§‹åŒ–è¿‡ç¨‹

---

## 9. å»¶ä¼¸é˜…è¯»

- [Geth æ¶æ„æ–‡æ¡£](https://geth.ethereum.org/docs/fundamentals/node-architecture)
- [devp2p åè®®è§„èŒƒ](https://github.com/ethereum/devp2p)
- [Engine API è§„èŒƒ](https://github.com/ethereum/execution-apis/tree/main/src/engine)
- [Geth æºç ](https://github.com/ethereum/go-ethereum)

---

**ä¸Šä¸€ç« **: [01 - ä»¥å¤ªåŠåŸºç¡€](./01-Ethereum-Fundamentals.md)  
**ä¸‹ä¸€ç« **: [03 - èŠ‚ç‚¹è®¾ç½®ä¸ç®¡ç†](./03-Node-Setup-and-Management.md)

