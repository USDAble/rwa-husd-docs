# 合约部署计划

**创建时间**: 2025-10-14 10:35:11 CST
**任务编号**: 002
**任务目标**: 按照依赖关系顺序部署所有 RWA-HUSD 合约,并更新相关文档和配置文件

---

## 📋 部署前准备

### 1. 确认分支状态

-   ✅ 所有 repos 已切换到 test-galahad 分支
-   ✅ redemption-contracts 已合并 audit-3.0.0 到 test-galahad

### 2. 部署网络

-   **目标网络**: Optimism Mainnet
-   **Chain ID**: 10
-   **RPC URL**: 从各 repo 的 .env 文件获取

### 3. 部署参数 (从 .env 文件获取)

-   `daoTreasury`: DAO 财务地址 (从 rwa-husd-contracts/.env)
-   `teamWallet`: 团队钱包地址 (从 rwa-husd-contracts/.env)
-   `multiSigWallet`: 多签钱包地址 (从 rwa-husd-contracts/.env)
-   `defaultPaymentToken`: `0x6e6Ed6c3B17EbbBb2b1E330C4C2e0974c4782591` (测试 USDC)
-   `maxBatchSize`: 100 (批量操作最大值)

### 4. 已部署的合约地址 (从 .env 获取)

-   **SystemConfig**: `0x3d119D3eC992cACF150F040F255CE5309E3fF66F`
-   **UserRegistry**: `0x3F3C9a258582663113eB4fA7D7d8F0E69e2C3b87`
-   **Treasury**: `0xBd92938E115C9da660c341713f10CF4ed363c8d4`
-   **RedemptionManager**: `0xB44CD75945f8321d77A9f906c094cC04737EB80A`

---

## 🎯 部署顺序和步骤

### 第 1 批: 基础合约 (无依赖)

#### 步骤 1: 部署 SystemConfig

-   **Repo**: rwa-husd-contracts
-   **合约**: SystemConfig.sol
-   **部署方式**: UUPS Proxy
-   **initialize 参数**:
    -   `_daoTreasury`: [待填写]
    -   `_teamWallet`: [待填写]
    -   `_multiSigWallet`: [待填写]
    -   `_defaultPaymentToken`: [待填写]
-   **部署后操作**:
    -   [ ] 记录 Proxy 地址到 `rwa-husd-contracts/Contract-ABIs.md`
    -   [ ] 更新 `rwa-husd-contracts/README.md`
    -   [ ] 更新以下 repos 的 `.env`:
        -   `rwa-husd-contracts/.env` (SYSTEM_CONFIG_ADDRESS)
        -   `treasury-contracts/.env` (SYSTEM_CONFIG_ADDRESS)
        -   `redemption-contracts/.env` (SYSTEM_CONFIG_ADDRESS)
        -   `rwa-husd-trading/.env` (SYSTEM_CONFIG_ADDRESS)
        -   `batch-token-transfer/hardhat-contracts/.env` (SYSTEM_CONFIG_ADDRESS)

#### 步骤 2: 部署 AbleToken (可与步骤 1 并行)

-   **Repo**: rwa-real-estate-community-coin-contract
-   **合约**: AbleToken.sol
-   **部署方式**: 直接部署 (非代理)
-   **constructor 参数**: 无
-   **部署后操作**:
    -   [ ] 记录合约地址到 `rwa-real-estate-community-coin-contract/Contract-ABIs.md`
    -   [ ] 更新 `rwa-real-estate-community-coin-contract/README.md`

---

### 第 2 批: 依赖 SystemConfig 的合约

#### 步骤 3: 部署 UserRegistry

-   **Repo**: rwa-husd-contracts
-   **合约**: UserRegistry.sol
-   **部署方式**: UUPS Proxy
-   **initialize 参数**:
    -   `_systemConfig`: [步骤 1 的 SystemConfig 地址]
-   **部署后操作**:
    -   [ ] 记录 Proxy 地址到 `rwa-husd-contracts/Contract-ABIs.md`
    -   [ ] 更新 `rwa-husd-contracts/README.md`
    -   [ ] 更新以下 repos 的 `.env`:
        -   `rwa-husd-contracts/.env` (USER_REGISTRY_ADDRESS)
        -   `redemption-contracts/.env` (USER_REGISTRY_ADDRESS)
        -   `rwa-husd-trading/.env` (USER_REGISTRY_ADDRESS)

#### 步骤 4: 部署 Treasury

-   **Repo**: treasury-contracts
-   **合约**: Treasury.sol
-   **部署方式**: UUPS Proxy
-   **initialize 参数**:
    -   `_systemConfig`: [步骤 1 的 SystemConfig 地址]
-   **部署后操作**:
    -   [ ] 记录 Proxy 地址到 `treasury-contracts/Contract-ABIs.md`
    -   [ ] 更新 `treasury-contracts/README.md`
    -   [ ] 更新以下 repos 的 `.env`:
        -   `treasury-contracts/.env` (TREASURY_ADDRESS)
        -   `rwa-husd-contracts/.env` (TREASURY_ADDRESS)
        -   `rwa-husd-trading/.env` (TREASURY_ADDRESS)

---

### 第 3 批: 依赖 SystemConfig + UserRegistry 的合约

#### 步骤 5: 部署 RedemptionManager

-   **Repo**: redemption-contracts
-   **合约**: RedemptionManager.sol
-   **部署方式**: UUPS Proxy
-   **initialize 参数**:
    -   `_systemConfig`: [步骤 1 的 SystemConfig 地址]
    -   `_userRegistry`: [步骤 3 的 UserRegistry 地址]
-   **部署后操作**:
    -   [ ] 记录 Proxy 地址到 `redemption-contracts/Contract-ABIs.md`
    -   [ ] 更新 `redemption-contracts/README.md`
    -   [ ] 更新以下 repos 的 `.env`:
        -   `redemption-contracts/.env` (REDEMPTION_MANAGER_ADDRESS)
        -   `rwa-husd-contracts/.env` (REDEMPTION_CONTRACT_ADDRESS)
        -   `treasury-contracts/.env` (REDEMPTION_CONTRACT_ADDRESS)

#### 步骤 6: 部署 TradeContract

-   **Repo**: rwa-husd-trading
-   **合约**: TradeContract.sol
-   **部署方式**: UUPS Proxy
-   **initialize 参数**:
    -   `_systemConfig`: [步骤 1 的 SystemConfig 地址]
    -   `_userRegistry`: [步骤 3 的 UserRegistry 地址]
    -   `_treasury`: [步骤 4 的 Treasury 地址]
-   **部署后操作**:
    -   [ ] 记录 Proxy 地址到 `rwa-husd-trading/Contract-ABIs.md`
    -   [ ] 更新 `rwa-husd-trading/README.md`

---

### 第 4 批: 依赖 Treasury + RedemptionManager 的合约

#### 步骤 7: 部署 RedemptionStrategy

-   **Repo**: treasury-contracts
-   **合约**: RedemptionStrategy.sol
-   **部署方式**: UUPS Proxy
-   **initialize 参数**:
    -   `_redemptionContract`: [步骤 5 的 RedemptionManager 地址]
    -   `_treasury`: [步骤 4 的 Treasury 地址]
-   **部署后操作**:
    -   [ ] 记录 Proxy 地址到 `treasury-contracts/Contract-ABIs.md`
    -   [ ] 更新 `treasury-contracts/README.md`
    -   [ ] 在 Treasury 合约中设置 RedemptionStrategy 地址

---

### 第 5 批: 依赖所有核心合约的合约

#### 步骤 8: 部署 PropertyToken (实现合约)

-   **Repo**: rwa-husd-contracts
-   **合约**: PropertyToken.sol
-   **部署方式**: 仅部署实现合约 (不初始化)
-   **constructor 参数**: 无
-   **部署后操作**:
    -   [ ] 记录实现合约地址到 `rwa-husd-contracts/Contract-ABIs.md`
    -   [ ] 更新 `rwa-husd-contracts/README.md`
    -   [ ] 更新 `rwa-husd-contracts/.env` (PROPERTY_TOKEN_IMPLEMENTATION)

#### 步骤 9: 部署 PropertyTokenFactory

-   **Repo**: rwa-husd-contracts
-   **合约**: PropertyTokenFactory.sol
-   **部署方式**: UUPS Proxy
-   **initialize 参数**:
    -   `_userRegistry`: [步骤 3 的 UserRegistry 地址]
    -   `_systemConfig`: [步骤 1 的 SystemConfig 地址]
    -   `_treasuryAddress`: [步骤 4 的 Treasury 地址]
    -   `_redemptionContract`: [步骤 5 的 RedemptionManager 地址]
    -   `_propertyTokenImplementation`: [步骤 8 的 PropertyToken 实现合约地址]
-   **部署后操作**:
    -   [ ] 记录 Proxy 地址到 `rwa-husd-contracts/Contract-ABIs.md`
    -   [ ] 更新 `rwa-husd-contracts/README.md`
    -   [ ] 更新 `rwa-husd-contracts/.env` (PROPERTY_TOKEN_FACTORY_ADDRESS)

---

### 第 6 批: 辅助工具和独立合约

#### 步骤 10: 部署 RentCustodyContract

-   **Repo**: batch-token-transfer
-   **合约**: RentCustodyContract.sol
-   **部署方式**: UUPS Proxy
-   **initialize 参数**:
    -   `_systemConfig`: [步骤 1 的 SystemConfig 地址]
    -   `_defaultPaymentToken`: [与 SystemConfig 相同的 defaultPaymentToken]
    -   `_maxBatchSize`: [建议: 100]
-   **部署后操作**:
    -   [ ] 记录 Proxy 地址到 `batch-token-transfer/hardhat-contracts/Contract-ABIs.md`
    -   [ ] 更新 `batch-token-transfer/hardhat-contracts/README.md`

#### 步骤 11: 部署 AbleVesting

-   **Repo**: rwa-real-estate-community-coin-contract
-   **合约**: AbleVesting.sol
-   **部署方式**: 直接部署 (非代理)
-   **constructor 参数**:
    -   `_ableToken`: [步骤 2 的 AbleToken 地址]
-   **部署后操作**:
    -   [ ] 记录合约地址到 `rwa-real-estate-community-coin-contract/Contract-ABIs.md`
    -   [ ] 更新 `rwa-real-estate-community-coin-contract/README.md`
    -   [ ] 调用 `initializeTge()` 初始化 TGE 时间戳

#### 步骤 12: 部署 AbleVestingFactory (可选)

-   **Repo**: rwa-real-estate-community-coin-contract
-   **合约**: AbleVestingFactory.sol
-   **部署方式**: 直接部署 (非代理)
-   **constructor 参数**: 无
-   **部署后操作**:
    -   [ ] 记录合约地址到 `rwa-real-estate-community-coin-contract/Contract-ABIs.md`
    -   [ ] 更新 `rwa-real-estate-community-coin-contract/README.md`

---

## 📝 部署后验证清单

### 1. 合约验证

-   [ ] 所有合约在区块链浏览器上验证源代码
-   [ ] 所有 Proxy 合约的实现地址正确
-   [ ] 所有合约的 owner/admin 角色正确

### 2. 文档更新验证

-   [ ] 所有 `Contract-ABIs.md` 文件已更新
-   [ ] 所有 `README.md` 文件已更新
-   [ ] 所有 `.env` 文件已更新

### 3. 功能验证

-   [ ] SystemConfig 的配置参数正确
-   [ ] UserRegistry 可以正常注册用户
-   [ ] PropertyTokenFactory 可以创建 PropertyToken
-   [ ] Treasury 可以接收资金
-   [ ] RedemptionManager 可以处理赎回请求
-   [ ] TradeContract 可以处理交易
-   [ ] RentCustodyContract 可以处理批量转账
-   [ ] AbleVesting 的 TGE 已初始化

---

## 🔄 部署进度追踪

| 步骤 | 合约名称             | Repo                 | 状态      | 合约地址 | 完成时间 |
| ---- | -------------------- | -------------------- | --------- | -------- | -------- |
| 1    | SystemConfig         | rwa-husd-contracts   | ⏳ 待部署 | -        | -        |
| 2    | AbleToken            | community-coin       | ⏳ 待部署 | -        | -        |
| 3    | UserRegistry         | rwa-husd-contracts   | ⏳ 待部署 | -        | -        |
| 4    | Treasury             | treasury-contracts   | ⏳ 待部署 | -        | -        |
| 5    | RedemptionManager    | redemption-contracts | ⏳ 待部署 | -        | -        |
| 6    | TradeContract        | rwa-husd-trading     | ⏳ 待部署 | -        | -        |
| 7    | RedemptionStrategy   | treasury-contracts   | ⏳ 待部署 | -        | -        |
| 8    | PropertyToken (Impl) | rwa-husd-contracts   | ⏳ 待部署 | -        | -        |
| 9    | PropertyTokenFactory | rwa-husd-contracts   | ⏳ 待部署 | -        | -        |
| 10   | RentCustodyContract  | batch-token-transfer | ⏳ 待部署 | -        | -        |
| 11   | AbleVesting          | community-coin       | ⏳ 待部署 | -        | -        |
| 12   | AbleVestingFactory   | community-coin       | ⏳ 待部署 | -        | -        |

---

## ⚠️ 注意事项

1. **部署顺序严格**: 必须按照上述顺序部署,否则会因为依赖关系导致初始化失败
2. **地址记录准确**: 每个合约部署后立即记录地址,避免后续步骤出错
3. **文档同步更新**: 每个合约部署后立即更新相关文档和 .env 文件
4. **Gas 费用准备**: 确保部署账户有足够的 Gas 费用
5. **权限管理**: 部署后及时设置正确的角色和权限
6. **测试网先行**: 建议先在测试网完整部署一遍,验证流程无误后再部署到主网

---

**计划制定完成时间**: 2025-10-14 10:35:11 CST
**下一步**: 等待用户确认后进入 E (Execute) 阶段
