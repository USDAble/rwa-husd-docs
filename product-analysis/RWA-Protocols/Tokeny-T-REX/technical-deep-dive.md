# Tokeny T-REX ä¸šåŠ¡æµç¨‹ä¸æŠ€æœ¯å®ç°æ·±åº¦è§£æ

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0
**åˆ›å»ºæ—¶é—´**: 2025-10-13 11:35:00 CST
**æ–‡æ¡£ç±»å‹**: ä¸šåŠ¡æµç¨‹å¯¼å‘çš„æŠ€æœ¯æ·±åº¦è§£æ
**æ ‡å‡†**: ERC3643ï¼ˆå®‰å…¨ä»£å¸æ ‡å‡†ï¼‰
**ä¿¡æ¯æ¥æº**: Tokeny å®˜æ–¹æ–‡æ¡£ (https://docs.tokeny.com/)

---

## ğŸ“‘ ç›®å½•

1. [Tokeny T-REX æ¦‚è¿°](#1-tokeny-t-rexæ¦‚è¿°)
2. [ä¸šåŠ¡æµç¨‹ 1: ä»£å¸éƒ¨ç½²ä¸é…ç½®](#2-ä¸šåŠ¡æµç¨‹1-ä»£å¸éƒ¨ç½²ä¸é…ç½®)
3. [ä¸šåŠ¡æµç¨‹ 2: æŠ•èµ„è€…èº«ä»½éªŒè¯(KYC)](#3-ä¸šåŠ¡æµç¨‹2-æŠ•èµ„è€…èº«ä»½éªŒè¯kyc)
4. [ä¸šåŠ¡æµç¨‹ 3: ä»£å¸å‘è¡Œä¸è½¬è´¦](#4-ä¸šåŠ¡æµç¨‹3-ä»£å¸å‘è¡Œä¸è½¬è´¦)
5. [ä¸šåŠ¡æµç¨‹ 4: åˆè§„æ£€æŸ¥ä¸é™åˆ¶](#5-ä¸šåŠ¡æµç¨‹4-åˆè§„æ£€æŸ¥ä¸é™åˆ¶)
6. [ä¸šåŠ¡æµç¨‹ 5: ä»£å¸èµå›ä¸é”€æ¯](#6-ä¸šåŠ¡æµç¨‹5-ä»£å¸èµå›ä¸é”€æ¯)
7. [å®Œæ•´ä¸šåŠ¡æµç¨‹å›¾](#7-å®Œæ•´ä¸šåŠ¡æµç¨‹å›¾)
8. [ERC3643 æ ‡å‡†è¯¦è§£](#8-erc3643æ ‡å‡†è¯¦è§£)
9. [å…³é”®åˆè§„è§„åˆ™](#9-å…³é”®åˆè§„è§„åˆ™)
10. [ç½‘ç»œä¿¡æ¯](#10-ç½‘ç»œä¿¡æ¯)
11. [æ€»ç»“ä¸æœ€ä½³å®è·µ](#11-æ€»ç»“ä¸æœ€ä½³å®è·µ)

---

## 1. Tokeny T-REX æ¦‚è¿°

### 1.1 æ ¸å¿ƒå®šä½

**Tokeny T-REX (Token for Regulated EXchanges) æ˜¯å®ç° ERC-3643 æ ‡å‡†çš„æœºæ„çº§å®‰å…¨ä»£å¸(Security Token)åè®®**,ä¸ºèµ„äº§å‘è¡Œè€…æä¾›å®Œæ•´çš„åˆè§„ä»£å¸åŒ–è§£å†³æ–¹æ¡ˆ,æ”¯æŒå…¨çƒç›‘ç®¡è¦æ±‚ã€‚

**å®˜æ–¹å®šä¹‰** (æ¥è‡ª [EIP-3643](https://eips.ethereum.org/EIPS/eip-3643)):

> "The T-REX token is an institutional grade security token standard. This standard provides a library of interfaces for the management and compliant transfer of security tokens, using an automated onchain validator system leveraging onchain identities for eligibility checks."

**æ ¸å¿ƒä»·å€¼ä¸»å¼ **:

-   **ERC-3643 æ ‡å‡†**: é¦–ä¸ªä¸“ä¸ºå®‰å…¨ä»£å¸è®¾è®¡çš„ä»¥å¤ªåŠæ ‡å‡† (EIP-3643)
-   **é“¾ä¸Šèº«ä»½ç®¡ç†**: åŸºäº ONCHAINID çš„å»ä¸­å¿ƒåŒ–èº«ä»½ç³»ç»Ÿ
-   **æƒé™åŒ–è½¬è´¦**: åªæœ‰ç»è¿‡éªŒè¯çš„æŠ•èµ„è€…æ‰èƒ½æŒæœ‰å’Œè½¬ç§»ä»£å¸
-   **å†…ç½®åˆè§„æ¡†æ¶**: è‡ªåŠ¨åŒ–çš„é“¾ä¸Šåˆè§„éªŒè¯ç³»ç»Ÿ
-   **æ¨¡å—åŒ–åˆè§„**: å¯æ’æ‹”çš„åˆè§„è§„åˆ™æ¨¡å—,é€‚åº”ä¸åŒç›‘ç®¡è¦æ±‚
-   **ERC-20 å…¼å®¹**: å‘åå…¼å®¹ ERC-20 æ ‡å‡†

---

### 1.2 ERC-3643 vs ERC-20

| ç‰¹æ€§         | ERC-20   | ERC-3643          |
| ------------ | -------- | ----------------- |
| **è½¬è´¦æƒé™** | æ— é™åˆ¶   | éœ€è¦èº«ä»½éªŒè¯      |
| **åˆè§„æ£€æŸ¥** | æ—        | å†…ç½®åˆè§„æ¨¡å—      |
| **èº«ä»½ç®¡ç†** | æ—        | ONCHAINID ç³»ç»Ÿ    |
| **é€‚ç”¨åœºæ™¯** | å®ç”¨ä»£å¸ | å®‰å…¨ä»£å¸(è¯åˆ¸)    |
| **KYC/AML**  | ä¸æ”¯æŒ   | åŸç”Ÿæ”¯æŒ          |
| **ä»£å¸å†»ç»“** | ä¸æ”¯æŒ   | æ”¯æŒéƒ¨åˆ†/å…¨éƒ¨å†»ç»“ |
| **å¼ºåˆ¶è½¬è´¦** | ä¸æ”¯æŒ   | æ”¯æŒ(Agent è§’è‰²)  |

---

### 1.3 ERC-3643 æ¶æ„æ¦‚è§ˆ

Tokeny T-REX é‡‡ç”¨**ERC-3643 æ ‡å‡†æ¶æ„**,ç”±ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶æ„æˆ:

#### æ ¸å¿ƒåˆçº¦å¥—ä»¶

1. **Token Contract (ä»£å¸åˆçº¦)**

    - å®ç° ERC-3643 æ¥å£,å…¼å®¹ ERC-20
    - ç®¡ç†ä»£å¸çš„é“¸é€ ã€é”€æ¯ã€è½¬è´¦
    - æ‰§è¡Œåˆè§„æ£€æŸ¥å’Œèº«ä»½éªŒè¯

2. **Identity Registry (èº«ä»½æ³¨å†Œè¡¨)**

    - å­˜å‚¨æ‰€æœ‰æˆæƒæŠ•èµ„è€…çš„èº«ä»½åˆçº¦åœ°å€
    - éªŒè¯æŠ•èµ„è€…çš„ ONCHAINID å’Œ Claims
    - ç®¡ç†æŠ•èµ„è€…çš„å›½å®¶ä»£ç  (ISO-3166)

3. **Identity Registry Storage (èº«ä»½æ³¨å†Œè¡¨å­˜å‚¨)**

    - åˆ†ç¦»èº«ä»½æ³¨å†Œè¡¨çš„å­˜å‚¨å’Œé€»è¾‘
    - æ”¯æŒå¤šä¸ªä»£å¸å…±äº«åŒä¸€æŠ•èµ„è€…ç™½åå•
    - æé«˜å­˜å‚¨æ•ˆç‡å’Œçµæ´»æ€§

4. **Claim Topics Registry (å£°æ˜ä¸»é¢˜æ³¨å†Œè¡¨)**

    - å®šä¹‰ä»£å¸æŒæœ‰è€…å¿…é¡»æ‹¥æœ‰çš„ Claims ç±»å‹
    - ä¾‹å¦‚: KYC å£°æ˜ã€åˆæ ¼æŠ•èµ„è€…å£°æ˜ã€å±…ä½å›½å®¶å£°æ˜

5. **Trusted Issuers Registry (å¯ä¿¡å‘è¡Œè€…æ³¨å†Œè¡¨)**

    - å­˜å‚¨æ‰€æœ‰å¯ä¿¡ Claim å‘è¡Œè€…çš„åœ°å€
    - åªæœ‰å¯ä¿¡å‘è¡Œè€…ç­¾å‘çš„ Claims æ‰è¢«è®¤å¯
    - æ”¯æŒä¸ºä¸åŒ Claim ä¸»é¢˜æŒ‡å®šä¸åŒçš„å‘è¡Œè€…

6. **Modular Compliance (æ¨¡å—åŒ–åˆè§„)**
    - å¯æ’æ‹”çš„åˆè§„è§„åˆ™æ¨¡å—
    - æ”¯æŒè‡ªå®šä¹‰åˆè§„é€»è¾‘
    - ç¤ºä¾‹æ¨¡å—: å›½å®¶é™åˆ¶ã€ä¾›åº”é‡é™åˆ¶ã€è½¬è´¦é™åˆ¶

#### ONCHAINID ç³»ç»Ÿ

**ONCHAINID** æ˜¯ ERC-3643 çš„æ ¸å¿ƒåˆ›æ–°,æ˜¯ä¸€ä¸ªå¼€æºçš„é“¾ä¸Šèº«ä»½ç®¡ç†ç³»ç»Ÿ:

-   **åŠŸèƒ½**: å­˜å‚¨å’ŒéªŒè¯èº«ä»½å£°æ˜ (Claims)
-   **ç»“æ„**: æ¯ä¸ªæŠ•èµ„è€…æœ‰ä¸€ä¸ª ONCHAINID åˆçº¦
-   **Claims**: ç”±å¯ä¿¡æœºæ„ç­¾å‘çš„èº«ä»½å£°æ˜,è¯æ˜æŠ•èµ„è€…çš„èµ„æ ¼

**Claims ç±»å‹ç¤ºä¾‹**:

### 1.3.1 ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    subgraph "èµ„äº§å±‚"
        A1[ç§å‹Ÿè¯åˆ¸]
        A2[æˆ¿åœ°äº§]
        A3[å€ºåˆ¸]
        A4[å…¶ä»–èµ„äº§]
    end

    subgraph "æ³•å¾‹å±‚"
        L1[SPV/Trust]
        L2[è½¬è®©ä»£ç†]
        L3[å…¨çƒè¯åˆ¸ç›‘ç®¡<br/>SEC/MiFID IIç­‰]
    end

    subgraph "Tokeny T-REXå¹³å°"
        P1[ä»£å¸éƒ¨ç½²ä¸é…ç½®]
        P2[æŠ•èµ„è€…èº«ä»½éªŒè¯KYC]
        P3[ä»£å¸å‘è¡Œä¸è½¬è´¦]
        P4[åˆè§„æ£€æŸ¥ä¸é™åˆ¶]
        P5[ä»£å¸èµå›ä¸é”€æ¯]
    end

    subgraph "ERC-3643æ ¸å¿ƒå±‚"
        T1[Token Contract<br/>ERC-3643/ERC-20]
        T2[Identity Registry<br/>èº«ä»½æ³¨å†Œè¡¨]
        T3[Claim Topics Registry<br/>å£°æ˜ä¸»é¢˜æ³¨å†Œè¡¨]
        T4[Trusted Issuers Registry<br/>å¯ä¿¡å‘è¡Œè€…æ³¨å†Œè¡¨]
        T5[Modular Compliance<br/>æ¨¡å—åŒ–åˆè§„]
    end

    subgraph "ONCHAINIDå±‚"
        O1[ONCHAINIDåˆçº¦<br/>é“¾ä¸Šèº«ä»½]
        O2[Claims<br/>èº«ä»½å£°æ˜]
        O3[KYC Claim]
        O4[Accredited Investor Claim]
        O5[Country Claim]
    end

    subgraph "åŒºå—é“¾å±‚"
        B1[Ethereum]
        B2[Polygon]
        B3[ERC-3643ä»£å¸]
    end

    subgraph "æŠ•èµ„è€…å±‚"
        I1[è®¤è¯æŠ•èµ„è€…]
        I2[æœºæ„æŠ•èµ„è€…]
        I3[é›¶å”®æŠ•èµ„è€…<br/>éƒ¨åˆ†å¸æ³•ç®¡è¾–åŒº]
    end

    A1 & A2 & A3 & A4 --> L1
    L1 --> L2
    L1 --> P1
    L3 --> P1

    P1 --> T1
    P2 --> T2
    T1 --> T2 & T3 & T4 & T5
    T2 --> O1
    O1 --> O2
    O2 --> O3 & O4 & O5

    T1 --> B1 & B2
    B1 & B2 --> B3

    B3 --> P4
    B3 --> P5

    P2 --> I1 & I2 & I3
    P3 --> I1 & I2 & I3

    style P1 fill:#e1f5ff
    style P2 fill:#e1f5ff
    style P3 fill:#e1f5ff
    style P4 fill:#e1f5ff
    style P5 fill:#e1f5ff
    style T1 fill:#4CAF50
    style T2 fill:#2196F3
    style T5 fill:#FF9800
    style O1 fill:#9C27B0
    style O2 fill:#F44336
    style L3 fill:#fff4e1
```

**ç³»ç»Ÿæ¶æ„è¯´æ˜**:

-   **èµ„äº§å±‚**: æ”¯æŒç§å‹Ÿè¯åˆ¸ã€æˆ¿åœ°äº§ã€å€ºåˆ¸ç­‰å¤šç§èµ„äº§ç±»å‹
-   **æ³•å¾‹å±‚**: SPV/Trust ç»“æ„ + è½¬è®©ä»£ç†æœåŠ¡ + å…¨çƒè¯åˆ¸ç›‘ç®¡åˆè§„
-   **å¹³å°å±‚**: Tokeny T-REX æ ¸å¿ƒå¹³å°,æä¾›å®Œæ•´çš„å®‰å…¨ä»£å¸ç”Ÿå‘½å‘¨æœŸç®¡ç†
-   **ERC-3643 æ ¸å¿ƒå±‚**: 5 ä¸ªæ ¸å¿ƒåˆçº¦,å®ç°æƒé™åŒ–è½¬è´¦å’Œè‡ªåŠ¨åŒ–åˆè§„
-   **ONCHAINID å±‚**: é“¾ä¸Šèº«ä»½ç®¡ç†ç³»ç»Ÿ,å­˜å‚¨å’ŒéªŒè¯æŠ•èµ„è€…èº«ä»½å£°æ˜
-   **åŒºå—é“¾å±‚**: æ”¯æŒ Ethereum å’Œ Polygon,åŸºäº ERC-3643 æ ‡å‡†
-   **æŠ•èµ„è€…å±‚**: æ”¯æŒè®¤è¯æŠ•èµ„è€…ã€æœºæ„æŠ•èµ„è€…å’Œé›¶å”®æŠ•èµ„è€…(éƒ¨åˆ†å¸æ³•ç®¡è¾–åŒº)

**æ ¸å¿ƒç‰¹æ€§**:

-   **ERC-3643 æ ‡å‡†**: é¦–ä¸ªä¸“ä¸ºå®‰å…¨ä»£å¸è®¾è®¡çš„ä»¥å¤ªåŠæ ‡å‡†,å‘åå…¼å®¹ ERC-20
-   **ONCHAINID èº«ä»½ç³»ç»Ÿ**: å»ä¸­å¿ƒåŒ–é“¾ä¸Šèº«ä»½ç®¡ç†,æ”¯æŒå¤šç§èº«ä»½å£°æ˜
-   **æƒé™åŒ–è½¬è´¦**: åªæœ‰ç»è¿‡éªŒè¯çš„æŠ•èµ„è€…æ‰èƒ½æŒæœ‰å’Œè½¬ç§»ä»£å¸
-   **æ¨¡å—åŒ–åˆè§„**: å¯æ’æ‹”çš„åˆè§„è§„åˆ™æ¨¡å—,é€‚åº”ä¸åŒç›‘ç®¡è¦æ±‚
-   **è‡ªåŠ¨åŒ–åˆè§„æ£€æŸ¥**: æ¯æ¬¡è½¬è´¦å‰è‡ªåŠ¨éªŒè¯èº«ä»½å’Œåˆè§„è§„åˆ™
-   **å¤šé“¾æ”¯æŒ**: Ethereum å’Œ Polygon åŒé“¾éƒ¨ç½²

---

**Claims ç±»å‹ç¤ºä¾‹**:

-   **Topic 1**: KYC å£°æ˜ (Know Your Customer)
-   **Topic 2**: åˆæ ¼æŠ•èµ„è€…å£°æ˜ (Accredited Investor)
-   **Topic 3**: å±…ä½å›½å®¶å£°æ˜ (Country of Residence)
-   **Topic 4**: AML æ£€æŸ¥å£°æ˜ (Anti-Money Laundering)

---

### 1.4 æ¶æ„å…³ç³»å›¾

```mermaid
graph TB
    Token[Token Contract<br/>ERC-3643]
    IR[Identity Registry]
    IRS[Identity Registry Storage]
    CTR[Claim Topics Registry]
    TIR[Trusted Issuers Registry]
    MC[Modular Compliance]

    Token -->|éªŒè¯èº«ä»½| IR
    Token -->|æ£€æŸ¥åˆè§„| MC
    IR -->|æŸ¥è¯¢å­˜å‚¨| IRS
    IR -->|éªŒè¯Claims| CTR
    IR -->|éªŒè¯ç­¾å‘è€…| TIR

    Investor[æŠ•èµ„è€…]
    ONCHAINID[ONCHAINID<br/>èº«ä»½åˆçº¦]
    ClaimIssuer[Claim Issuer<br/>å¯ä¿¡å‘è¡Œè€…]

    Investor -->|æ‹¥æœ‰| ONCHAINID
    ClaimIssuer -->|ç­¾å‘Claims| ONCHAINID
    IRS -->|å­˜å‚¨| ONCHAINID
    TIR -->|ä¿¡ä»»| ClaimIssuer
```

---

## 2. ä¸šåŠ¡æµç¨‹ 1: ä»£å¸éƒ¨ç½²ä¸é…ç½® âœ… å®˜æ–¹éªŒè¯

**éªŒè¯çŠ¶æ€**: âœ… å·²å¯¹é½ ERC-3643 å®˜æ–¹æ ‡å‡†
**å®˜æ–¹æ–‡æ¡£**: [EIP-3643](https://eips.ethereum.org/EIPS/eip-3643), [ERC-3643 GitHub](https://github.com/ERC-3643/ERC-3643)

### 2.1 æµç¨‹æ¦‚è¿°

ä»£å¸éƒ¨ç½²æ˜¯ Tokeny T-REX ä¸šåŠ¡æµç¨‹çš„èµ·ç‚¹,ç”±èµ„äº§å‘è¡Œè€…(Issuer)å‘èµ·,é€šè¿‡ T-REX Factory åˆçº¦éƒ¨ç½²ä¸€ä¸ªæ–°çš„ ERC-3643 ä»£å¸ã€‚

**æ¶‰åŠçš„åˆçº¦**: TREXFactory, Token (IERC3643), IdentityRegistry, IdentityRegistryStorage, ModularCompliance

**æ ¸å¿ƒæ­¥éª¤**:

1. å‘è¡Œè€…è°ƒç”¨ TREXFactory.deployTREXSuite() éƒ¨ç½²å®Œæ•´çš„ä»£å¸å¥—ä»¶
2. Factory éƒ¨ç½² Token åˆçº¦ (å®ç° IERC3643 æ¥å£)
3. Factory éƒ¨ç½² IdentityRegistry åˆçº¦
4. Factory éƒ¨ç½² IdentityRegistryStorage åˆçº¦
5. Factory éƒ¨ç½² ModularCompliance åˆçº¦
6. Factory éƒ¨ç½² ClaimTopicsRegistry å’Œ TrustedIssuersRegistry
7. é…ç½®ä»£å¸å‚æ•°(åç§°ã€ç¬¦å·ã€å°æ•°ä½æ•°ã€ONCHAINID)
8. ç»‘å®šæ‰€æœ‰åˆçº¦å¹¶è½¬ç§»æ‰€æœ‰æƒç»™å‘è¡Œè€…

---

### 2.2 è¯¦ç»†æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant Issuer as èµ„äº§å‘è¡Œè€…
    participant Factory as TokenFactoryåˆçº¦
    participant Token as Tokenåˆçº¦
    participant IR as IdentityRegistryåˆçº¦
    participant MC as ModularComplianceåˆçº¦

    Issuer->>Factory: 1. deployToken(name, symbol, decimals)
    Factory->>Token: 2. éƒ¨ç½²Tokenåˆçº¦
    Token-->>Factory: 3. è¿”å›Tokenåœ°å€
    Factory->>IR: 4. éƒ¨ç½²IdentityRegistryåˆçº¦
    IR-->>Factory: 5. è¿”å›IRåœ°å€
    Factory->>MC: 6. éƒ¨ç½²ModularComplianceåˆçº¦
    MC-->>Factory: 7. è¿”å›MCåœ°å€
    Factory->>Token: 8. setIdentityRegistry(IR)
    Factory->>Token: 9. setCompliance(MC)
    Factory-->>Issuer: 10. è¿”å›éƒ¨ç½²æˆåŠŸ
```

---

### 2.3 TREXFactory åˆçº¦è¯¦è§£

**èŒè´£**: T-REX å·¥å‚åˆçº¦,ç”¨äºéƒ¨ç½²å®Œæ•´çš„ ERC-3643 ä»£å¸å¥—ä»¶

**å®˜æ–¹æ¥å£** (æ¥è‡ª [ERC-3643 GitHub](https://github.com/ERC-3643/ERC-3643)):

```solidity
interface ITREXFactory {
    // äº‹ä»¶
    event TREXSuiteDeployed(
        address indexed token,
        address indexed identityRegistry,
        address indexed compliance,
        string indexed name,
        string indexed symbol
    );

    // éƒ¨ç½²å®Œæ•´çš„ T-REX å¥—ä»¶
    function deployTREXSuite(
        string memory _name,
        string memory _symbol,
        uint8 _decimals,
        address _onchainID
    ) external returns (address);
}
```

---

### 2.4 ä»£ç ç¤ºä¾‹

#### 2.4.1 å®Œæ•´çš„ä»£å¸éƒ¨ç½²æµç¨‹ (Solidity)

ä»¥ä¸‹ä»£ç å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ TREXFactory éƒ¨ç½²ä¸€ä¸ªå®Œæ•´çš„ ERC-3643 ä»£å¸å¥—ä»¶:

```solidity
// SPDX-License-Identifier: GPL-3.0
pragma solidity ^0.8.0;

import "@erc-3643/core/contracts/token/Token.sol";
import "@erc-3643/core/contracts/registry/IdentityRegistry.sol";
import "@erc-3643/core/contracts/registry/IdentityRegistryStorage.sol";
import "@erc-3643/core/contracts/compliance/ModularCompliance.sol";
import "@erc-3643/core/contracts/registry/ClaimTopicsRegistry.sol";
import "@erc-3643/core/contracts/registry/TrustedIssuersRegistry.sol";

/**
 * @title TREXFactory
 * @dev éƒ¨ç½²å®Œæ•´çš„ ERC-3643 ä»£å¸å¥—ä»¶
 */
contract TREXFactory {
    // äº‹ä»¶
    event TREXSuiteDeployed(
        address indexed token,
        address indexed identityRegistry,
        address indexed compliance,
        string name,
        string symbol
    );

    /**
     * @dev éƒ¨ç½²å®Œæ•´çš„ T-REX ä»£å¸å¥—ä»¶
     * @param _name ä»£å¸åç§°
     * @param _symbol ä»£å¸ç¬¦å·
     * @param _decimals å°æ•°ä½æ•°
     * @param _onchainID å‘è¡Œè€…çš„ ONCHAINID åœ°å€
     * @return token éƒ¨ç½²çš„ä»£å¸åœ°å€
     */
    function deployTREXSuite(
        string memory _name,
        string memory _symbol,
        uint8 _decimals,
        address _onchainID
    ) external returns (address token) {
        console.log("=== å¼€å§‹éƒ¨ç½² T-REX ä»£å¸å¥—ä»¶ ===");
        console.log("ä»£å¸åç§°:", _name);
        console.log("ä»£å¸ç¬¦å·:", _symbol);
        console.log("å‘è¡Œè€… ONCHAINID:", _onchainID);

        // 1. éƒ¨ç½² IdentityRegistryStorage
        IdentityRegistryStorage identityStorage = new IdentityRegistryStorage();
        console.log("âœ“ IdentityRegistryStorage å·²éƒ¨ç½²:", address(identityStorage));

        // 2. éƒ¨ç½² ClaimTopicsRegistry
        ClaimTopicsRegistry claimTopicsRegistry = new ClaimTopicsRegistry();
        console.log("âœ“ ClaimTopicsRegistry å·²éƒ¨ç½²:", address(claimTopicsRegistry));

        // 3. éƒ¨ç½² TrustedIssuersRegistry
        TrustedIssuersRegistry trustedIssuersRegistry = new TrustedIssuersRegistry();
        console.log("âœ“ TrustedIssuersRegistry å·²éƒ¨ç½²:", address(trustedIssuersRegistry));

        // 4. éƒ¨ç½² IdentityRegistry
        IdentityRegistry identityRegistry = new IdentityRegistry(
            address(trustedIssuersRegistry),
            address(claimTopicsRegistry),
            address(identityStorage)
        );
        console.log("âœ“ IdentityRegistry å·²éƒ¨ç½²:", address(identityRegistry));

        // 5. ç»‘å®š IdentityRegistry åˆ° Storage
        identityStorage.bindIdentityRegistry(address(identityRegistry));
        console.log("âœ“ IdentityRegistry å·²ç»‘å®šåˆ° Storage");

        // 6. éƒ¨ç½² ModularCompliance
        ModularCompliance compliance = new ModularCompliance();
        console.log("âœ“ ModularCompliance å·²éƒ¨ç½²:", address(compliance));

        // 7. éƒ¨ç½² Token åˆçº¦
        Token tokenContract = new Token(
            _name,
            _symbol,
            _decimals,
            _onchainID
        );
        console.log("âœ“ Token å·²éƒ¨ç½²:", address(tokenContract));

        // 8. é…ç½® Token
        tokenContract.setIdentityRegistry(address(identityRegistry));
        tokenContract.setCompliance(address(compliance));
        console.log("âœ“ Token é…ç½®å®Œæˆ");

        // 9. ç»‘å®š Compliance åˆ° Token
        compliance.bindToken(address(tokenContract));
        console.log("âœ“ Compliance å·²ç»‘å®šåˆ° Token");

        // 10. è½¬ç§»æ‰€æœ‰æƒç»™å‘è¡Œè€…
        tokenContract.transferOwnership(msg.sender);
        identityRegistry.transferOwnership(msg.sender);
        identityStorage.transferOwnership(msg.sender);
        compliance.transferOwnership(msg.sender);
        claimTopicsRegistry.transferOwnership(msg.sender);
        trustedIssuersRegistry.transferOwnership(msg.sender);
        console.log("âœ“ æ‰€æœ‰æƒå·²è½¬ç§»ç»™å‘è¡Œè€…:", msg.sender);

        // 11. è§¦å‘äº‹ä»¶
        emit TREXSuiteDeployed(
            address(tokenContract),
            address(identityRegistry),
            address(compliance),
            _name,
            _symbol
        );

        console.log("=== T-REX ä»£å¸å¥—ä»¶éƒ¨ç½²å®Œæˆ ===");
        return address(tokenContract);
    }
}
```

#### 2.4.2 è°ƒç”¨ç¤ºä¾‹

```solidity
// éƒ¨ç½² TREXFactory
TREXFactory factory = new TREXFactory();

// éƒ¨ç½²ä»£å¸å¥—ä»¶
address tokenAddress = factory.deployTREXSuite(
    "Security Token",      // ä»£å¸åç§°
    "SEC",                 // ä»£å¸ç¬¦å·
    18,                    // å°æ•°ä½æ•°
    issuerONCHAINID        // å‘è¡Œè€…çš„ ONCHAINID åœ°å€
);
        decimals: number;
        onchainID: string;
    }
) {
    try {
        // 1. éƒ¨ç½²ä»£å¸
        console.log("Deploying security token...");
        const tx = await factoryContract.deployToken(
            tokenConfig.name,
            tokenConfig.symbol,
            tokenConfig.decimals,
            tokenConfig.onchainID
        );

        const receipt = await tx.wait();
        console.log("âœ… Token deployed");

        // 2. è·å–ä»£å¸åœ°å€
        const event = receipt.events.find((e) => e.event === "TokenDeployed");
        const tokenAddress = event.args.tokenAddress;

        return {
            tokenAddress,
            name: tokenConfig.name,
            symbol: tokenConfig.symbol,
            status: "deployed",
        };
    } catch (error) {
        console.error("Error deploying token:", error);
        throw error;
    }
}
```

---

## 3. ä¸šåŠ¡æµç¨‹ 2: æŠ•èµ„è€…èº«ä»½éªŒè¯(KYC) âœ… å®˜æ–¹éªŒè¯

**éªŒè¯çŠ¶æ€**: âœ… å·²å¯¹é½ ERC-3643 å®˜æ–¹æ ‡å‡†
**å®˜æ–¹æ–‡æ¡£**: [EIP-3643](https://eips.ethereum.org/EIPS/eip-3643), [ONCHAINID](https://github.com/onchain-id/solidity)

### 3.1 æµç¨‹æ¦‚è¿°

æŠ•èµ„è€…èº«ä»½éªŒè¯æ˜¯ ERC-3643 çš„æ ¸å¿ƒåˆ›æ–°,é€šè¿‡é“¾ä¸Šèº«ä»½(ONCHAINID)å’Œå£°æ˜(Claims)å®ç°å»ä¸­å¿ƒåŒ–çš„ KYC/AML éªŒè¯ã€‚

**æ¶‰åŠçš„åˆçº¦**: IdentityRegistry, IdentityRegistryStorage, ClaimIssuer, ONCHAINID (IIdentity), TrustedIssuersRegistry, ClaimTopicsRegistry

**æ ¸å¿ƒæ­¥éª¤**:

1. æŠ•èµ„è€…éƒ¨ç½² ONCHAINID åˆçº¦(é“¾ä¸Šèº«ä»½)
2. KYC æä¾›å•†éªŒè¯æŠ•èµ„è€…èº«ä»½(é“¾ä¸‹)
3. KYC æä¾›å•†ä½œä¸º ClaimIssuer ç­¾å‘ Claims åˆ°æŠ•èµ„è€…çš„ ONCHAINID
4. å‘è¡Œè€…å°† ClaimIssuer æ·»åŠ åˆ° TrustedIssuersRegistry
5. å‘è¡Œè€…å°†æ‰€éœ€çš„ Claim Topics æ·»åŠ åˆ° ClaimTopicsRegistry
6. å‘è¡Œè€…å°†æŠ•èµ„è€…çš„ ONCHAINID æ³¨å†Œåˆ° IdentityRegistry
7. IdentityRegistry éªŒè¯æŠ•èµ„è€…çš„ Claims æ˜¯å¦æœ‰æ•ˆ
8. æŠ•èµ„è€…è·å¾—ä»£å¸æŒæœ‰å’Œè½¬è´¦æƒé™

---

### 3.2 ONCHAINID ç³»ç»Ÿè¯¦è§£

#### 3.2.1 ONCHAINID æ¦‚å¿µ

**ONCHAINID** æ˜¯ä¸€ä¸ªå¼€æºçš„é“¾ä¸Šèº«ä»½ç®¡ç†ç³»ç»Ÿ,æ˜¯ ERC-3643 çš„æ ¸å¿ƒç»„ä»¶:

-   **å®šä¹‰**: æ¯ä¸ªæŠ•èµ„è€…æ‹¥æœ‰ä¸€ä¸ª ONCHAINID åˆçº¦,å­˜å‚¨å…¶èº«ä»½ä¿¡æ¯å’Œ Claims
-   **åŠŸèƒ½**: ç®¡ç†å¯†é’¥ã€å­˜å‚¨ Claimsã€éªŒè¯ç­¾å
-   **æ ‡å‡†**: å®ç° IIdentity æ¥å£ (åŸºäº ERC-734 å’Œ ERC-735)
-   **å»ä¸­å¿ƒåŒ–**: æŠ•èµ„è€…å®Œå…¨æ§åˆ¶è‡ªå·±çš„èº«ä»½åˆçº¦

#### 3.2.2 Claims æœºåˆ¶

**Claims** æ˜¯ç”±å¯ä¿¡æœºæ„ç­¾å‘çš„èº«ä»½å£°æ˜,è¯æ˜æŠ•èµ„è€…çš„èµ„æ ¼:

**Claim ç»“æ„**:

```solidity
struct Claim {
    uint256 topic;        // Claim ä¸»é¢˜ (ä¾‹å¦‚: 1 = KYC)
    uint256 scheme;       // ç­¾åæ–¹æ¡ˆ (ä¾‹å¦‚: 1 = ECDSA)
    address issuer;       // ç­¾å‘è€…åœ°å€ (ClaimIssuer)
    bytes signature;      // ç­¾åæ•°æ®
    bytes data;           // Claim æ•°æ®
    string uri;           // æ•°æ® URI (å¯é€‰)
}
```

**å¸¸è§ Claim Topics**:

-   **Topic 1**: KYC å£°æ˜ (Know Your Customer) - è¯æ˜æŠ•èµ„è€…å·²å®Œæˆ KYC
-   **Topic 2**: åˆæ ¼æŠ•èµ„è€…å£°æ˜ (Accredited Investor) - è¯æ˜æŠ•èµ„è€…æ˜¯åˆæ ¼æŠ•èµ„è€…
-   **Topic 3**: å±…ä½å›½å®¶å£°æ˜ (Country of Residence) - è¯æ˜æŠ•èµ„è€…çš„å±…ä½å›½å®¶
-   **Topic 4**: AML æ£€æŸ¥å£°æ˜ (Anti-Money Laundering) - è¯æ˜æŠ•èµ„è€…å·²é€šè¿‡ AML æ£€æŸ¥

#### 3.2.3 Claim éªŒè¯æµç¨‹

å½“æŠ•èµ„è€…å°è¯•æ¥æ”¶ä»£å¸æ—¶,IdentityRegistry ä¼šéªŒè¯:

1. **Claim å­˜åœ¨æ€§**: æŠ•èµ„è€…çš„ ONCHAINID æ˜¯å¦åŒ…å«æ‰€éœ€çš„ Claim Topics
2. **Claim ç­¾å‘è€…**: Claim æ˜¯å¦ç”± TrustedIssuersRegistry ä¸­çš„å¯ä¿¡å‘è¡Œè€…ç­¾å‘
3. **Claim æœ‰æ•ˆæ€§**: Claim çš„ç­¾åæ˜¯å¦æœ‰æ•ˆ
4. **Claim æ—¶æ•ˆæ€§**: Claim æ˜¯å¦åœ¨æœ‰æ•ˆæœŸå†… (å¦‚æœè®¾ç½®äº†è¿‡æœŸæ—¶é—´)

---

### 3.2 è¯¦ç»†æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant Investor as æŠ•èµ„è€…
    participant ONCHAINID as ONCHAINIDåˆçº¦
    participant KYC as KYCæä¾›å•†
    participant ClaimIssuer as ClaimIssueråˆçº¦
    participant IR as IdentityRegistryåˆçº¦
    participant Issuer as èµ„äº§å‘è¡Œè€…

    Investor->>ONCHAINID: 1. åˆ›å»ºONCHAINID
    ONCHAINID-->>Investor: 2. è¿”å›èº«ä»½ID
    Investor->>KYC: 3. æäº¤KYCèµ„æ–™
    KYC->>KYC: 4. éªŒè¯èº«ä»½
    KYC->>ClaimIssuer: 5. ç­¾å‘å£°æ˜(Claim)
    ClaimIssuer->>ONCHAINID: 6. æ·»åŠ å£°æ˜åˆ°ONCHAINID
    ONCHAINID-->>Investor: 7. è¿”å›å£°æ˜æ·»åŠ æˆåŠŸ
    Issuer->>IR: 8. registerIdentity(investor, onchainID)
    IR-->>Issuer: 9. è¿”å›æ³¨å†ŒæˆåŠŸ
    Investor-->>Investor: 10. è·å¾—ä»£å¸è½¬è´¦æƒé™
```

---

### 3.3 IdentityRegistry åˆçº¦è¯¦è§£

**èŒè´£**: èº«ä»½æ³¨å†Œè¡¨,ç®¡ç†æŠ•èµ„è€…èº«ä»½å’ŒéªŒè¯çŠ¶æ€

**å®˜æ–¹æ¥å£** (æ¥è‡ª [EIP-3643](https://eips.ethereum.org/EIPS/eip-3643)):

```solidity
interface IIdentityRegistry {
    // äº‹ä»¶
    event IdentityRegistered(address indexed investorAddress, IIdentity indexed identity);
    event IdentityRemoved(address indexed investorAddress, IIdentity indexed identity);
    event IdentityUpdated(IIdentity indexed oldIdentity, IIdentity indexed newIdentity);
    event CountryUpdated(address indexed investorAddress, uint16 indexed country);

    // æ³¨å†ŒæŠ•èµ„è€…èº«ä»½
    function registerIdentity(
        address _userAddress,
        IIdentity _identity,
        uint16 _country
    ) external;

    // éªŒè¯æŠ•èµ„è€…æ˜¯å¦æœ‰æ•ˆ
    function isVerified(address _userAddress) external view returns (bool);

    // æŸ¥è¯¢æŠ•èµ„è€…çš„ ONCHAINID
    function identity(address _userAddress) external view returns (IIdentity);

    // æŸ¥è¯¢æŠ•èµ„è€…çš„å›½å®¶ä»£ç 
    function investorCountry(address _userAddress) external view returns (uint16);
}
```

**isVerified() å‡½æ•°è¯¦è§£**:

`isVerified()` æ˜¯ ERC-3643 çš„æ ¸å¿ƒå‡½æ•°,ç”¨äºéªŒè¯æŠ•èµ„è€…æ˜¯å¦æœ‰èµ„æ ¼æŒæœ‰ä»£å¸:

```solidity
function isVerified(address _userAddress) public view returns (bool) {
    // 1. æ£€æŸ¥æŠ•èµ„è€…æ˜¯å¦åœ¨æ³¨å†Œè¡¨ä¸­
    IIdentity identity = identity(_userAddress);
    if (address(identity) == address(0)) {
        return false;
    }

    // 2. è·å–æ‰€éœ€çš„ Claim Topics
    uint256[] memory requiredTopics = claimTopicsRegistry.getClaimTopics();

    // 3. éªŒè¯æ¯ä¸ª Claim Topic
    for (uint256 i = 0; i < requiredTopics.length; i++) {
        uint256 topic = requiredTopics[i];

        // 3.1 è·å–è¯¥ Topic çš„å¯ä¿¡å‘è¡Œè€…
        IClaimIssuer[] memory issuers = trustedIssuersRegistry.getTrustedIssuersForClaimTopic(topic);

        // 3.2 æ£€æŸ¥ ONCHAINID æ˜¯å¦æœ‰è¯¥ Topic çš„æœ‰æ•ˆ Claim
        bool hasValidClaim = false;
        for (uint256 j = 0; j < issuers.length; j++) {
            bytes32 claimId = keccak256(abi.encode(address(issuers[j]), topic));
            if (identity.getClaimIdsByTopic(topic).length > 0) {
                // éªŒè¯ Claim ç­¾å
                (uint256 claimTopic, uint256 scheme, address issuer, bytes memory sig, bytes memory data, string memory uri) = identity.getClaim(claimId);
                if (issuer == address(issuers[j]) && _isClaimValid(identity, claimId, topic, sig, data)) {
                    hasValidClaim = true;
                    break;
                }
            }
        }

        if (!hasValidClaim) {
            return false;
        }
    }

    return true;
}
```

---

### 3.4 ä»£ç ç¤ºä¾‹

#### 3.4.1 å®Œæ•´çš„æŠ•èµ„è€… KYC ä¸èº«ä»½æ³¨å†Œæµç¨‹ (Solidity)

ä»¥ä¸‹ä»£ç å±•ç¤ºäº†ä» ONCHAINID åˆ›å»ºåˆ°æŠ•èµ„è€…æ³¨å†Œçš„å®Œæ•´æµç¨‹:

```solidity
// SPDX-License-Identifier: GPL-3.0
pragma solidity ^0.8.0;

import "@onchain-id/solidity/contracts/Identity.sol";
import "@onchain-id/solidity/contracts/ClaimIssuer.sol";
import "@erc-3643/core/contracts/registry/IdentityRegistry.sol";
import "@erc-3643/core/contracts/registry/TrustedIssuersRegistry.sol";
import "@erc-3643/core/contracts/registry/ClaimTopicsRegistry.sol";

/**
 * @title InvestorOnboarding
 * @dev æŠ•èµ„è€… KYC ä¸èº«ä»½æ³¨å†Œå®Œæ•´æµç¨‹
 */
contract InvestorOnboarding {
    IdentityRegistry public identityRegistry;
    TrustedIssuersRegistry public trustedIssuersRegistry;
    ClaimTopicsRegistry public claimTopicsRegistry;

    constructor(
        address _identityRegistry,
        address _trustedIssuersRegistry,
        address _claimTopicsRegistry
    ) {
        identityRegistry = IdentityRegistry(_identityRegistry);
        trustedIssuersRegistry = TrustedIssuersRegistry(_trustedIssuersRegistry);
        claimTopicsRegistry = ClaimTopicsRegistry(_claimTopicsRegistry);
    }

    /**
     * @dev æ­¥éª¤ 1: æŠ•èµ„è€…åˆ›å»º ONCHAINID
     * @param _investor æŠ•èµ„è€…åœ°å€
     * @return identityAddress åˆ›å»ºçš„ ONCHAINID åœ°å€
     */
    function createONCHAINID(address _investor) external returns (address identityAddress) {
        console.log("=== æ­¥éª¤ 1: åˆ›å»º ONCHAINID ===");
        console.log("æŠ•èµ„è€…åœ°å€:", _investor);

        // éƒ¨ç½² Identity åˆçº¦
        Identity identity = new Identity(_investor, true);
        console.log("âœ“ ONCHAINID å·²åˆ›å»º:", address(identity));

        return address(identity);
    }

    /**
     * @dev æ­¥éª¤ 2: KYC æä¾›å•†ç­¾å‘ Claim
     * @param _identity æŠ•èµ„è€…çš„ ONCHAINID åœ°å€
     * @param _claimIssuer ClaimIssuer åœ°å€
     * @param _topic Claim ä¸»é¢˜ (ä¾‹å¦‚: 1 = KYC)
     * @param _data Claim æ•°æ®
     */
    function issueClaim(
        address _identity,
        address _claimIssuer,
        uint256 _topic,
        bytes memory _data
    ) external {
        console.log("=== æ­¥éª¤ 2: ç­¾å‘ Claim ===");
        console.log("ONCHAINID:", _identity);
        console.log("Claim Topic:", _topic);

        Identity identity = Identity(_identity);
        ClaimIssuer claimIssuer = ClaimIssuer(_claimIssuer);

        // 1. ClaimIssuer ç­¾å Claim æ•°æ®
        bytes32 dataHash = keccak256(abi.encode(_identity, _topic, _data));
        bytes memory signature = claimIssuer.signClaim(_topic, _data);
        console.log("âœ“ Claim å·²ç­¾å");

        // 2. æ·»åŠ  Claim åˆ° ONCHAINID
        bytes32 claimId = keccak256(abi.encode(_claimIssuer, _topic));
        identity.addClaim(
            _topic,
            1,              // scheme: ECDSA
            _claimIssuer,
            signature,
            _data,
            ""              // uri (å¯é€‰)
        );
        console.log("âœ“ Claim å·²æ·»åŠ åˆ° ONCHAINID");
        console.log("  Claim ID:", claimId);
    }

    /**
     * @dev æ­¥éª¤ 3: é…ç½®å¯ä¿¡å‘è¡Œè€…å’Œ Claim Topics
     * @param _claimIssuer ClaimIssuer åœ°å€
     * @param _topics è¯¥å‘è¡Œè€…å¯ä»¥ç­¾å‘çš„ Claim Topics
     */
    function configureTrustedIssuer(
        address _claimIssuer,
        uint256[] memory _topics
    ) external {
        console.log("=== æ­¥éª¤ 3: é…ç½®å¯ä¿¡å‘è¡Œè€… ===");
        console.log("ClaimIssuer:", _claimIssuer);

        // 1. æ·»åŠ åˆ° TrustedIssuersRegistry
        trustedIssuersRegistry.addTrustedIssuer(
            IClaimIssuer(_claimIssuer),
            _topics
        );
        console.log("âœ“ ClaimIssuer å·²æ·»åŠ åˆ° TrustedIssuersRegistry");

        // 2. æ·»åŠ  Claim Topics åˆ° ClaimTopicsRegistry
        for (uint256 i = 0; i < _topics.length; i++) {
            if (!_isTopicRegistered(_topics[i])) {
                claimTopicsRegistry.addClaimTopic(_topics[i]);
                console.log("âœ“ Claim Topic å·²æ·»åŠ :", _topics[i]);
            }
        }
    }

    /**
     * @dev æ­¥éª¤ 4: æ³¨å†ŒæŠ•èµ„è€…åˆ° IdentityRegistry
     * @param _investor æŠ•èµ„è€…åœ°å€
     * @param _identity æŠ•èµ„è€…çš„ ONCHAINID åœ°å€
     * @param _country å›½å®¶ä»£ç  (ISO 3166-1)
     */
    function registerInvestor(
        address _investor,
        address _identity,
        uint16 _country
    ) external {
        console.log("=== æ­¥éª¤ 4: æ³¨å†ŒæŠ•èµ„è€… ===");
        console.log("æŠ•èµ„è€…åœ°å€:", _investor);
        console.log("ONCHAINID:", _identity);
        console.log("å›½å®¶ä»£ç :", _country);

        // æ³¨å†Œåˆ° IdentityRegistry
        identityRegistry.registerIdentity(
            _investor,
            IIdentity(_identity),
            _country
        );
        console.log("âœ“ æŠ•èµ„è€…å·²æ³¨å†Œåˆ° IdentityRegistry");

        // éªŒè¯æŠ•èµ„è€…çŠ¶æ€
        bool isVerified = identityRegistry.isVerified(_investor);
        console.log("âœ“ æŠ•èµ„è€…éªŒè¯çŠ¶æ€:", isVerified ? "å·²éªŒè¯" : "æœªéªŒè¯");

        require(isVerified, "æŠ•èµ„è€…éªŒè¯å¤±è´¥");
    }

    /**
     * @dev è¾…åŠ©å‡½æ•°: æ£€æŸ¥ Claim Topic æ˜¯å¦å·²æ³¨å†Œ
     */
    function _isTopicRegistered(uint256 _topic) internal view returns (bool) {
        uint256[] memory topics = claimTopicsRegistry.getClaimTopics();
        for (uint256 i = 0; i < topics.length; i++) {
            if (topics[i] == _topic) {
                return true;
            }
        }
        return false;
    }
}
```

#### 3.4.2 è°ƒç”¨ç¤ºä¾‹

```solidity
// 1. åˆ›å»º ONCHAINID
address onchainID = onboarding.createONCHAINID(investorAddress);

// 2. KYC æä¾›å•†ç­¾å‘ KYC Claim (Topic 1)
onboarding.issueClaim(
    onchainID,
    kycProviderAddress,
    1,                          // Topic 1 = KYC
    abi.encode("KYC Verified")  // Claim æ•°æ®
);

// 3. é…ç½®å¯ä¿¡å‘è¡Œè€…
uint256[] memory topics = new uint256[](1);
topics[0] = 1;  // KYC Topic
onboarding.configureTrustedIssuer(kycProviderAddress, topics);

// 4. æ³¨å†ŒæŠ•èµ„è€…
onboarding.registerInvestor(
    investorAddress,
    onchainID,
    840  // ç¾å›½ (ISO 3166-1)
);
```

---

## 4. ä¸šåŠ¡æµç¨‹ 3: ä»£å¸è½¬è´¦ âœ… å®˜æ–¹éªŒè¯

**éªŒè¯çŠ¶æ€**: âœ… å·²å¯¹é½ ERC-3643 å®˜æ–¹æ ‡å‡†
**å®˜æ–¹æ–‡æ¡£**: [EIP-3643](https://eips.ethereum.org/EIPS/eip-3643), [ERC-3643 GitHub](https://github.com/ERC-3643/ERC-3643)

### 4.1 æµç¨‹æ¦‚è¿°

ä»£å¸è½¬è´¦æ˜¯ ERC-3643 çš„æ ¸å¿ƒä¸šåŠ¡æµç¨‹,æ‰€æœ‰è½¬è´¦éƒ½éœ€è¦é€šè¿‡èº«ä»½éªŒè¯å’Œåˆè§„æ£€æŸ¥ã€‚

**æ¶‰åŠçš„åˆçº¦**: Token (IERC3643), ModularCompliance, IdentityRegistry

**æ ¸å¿ƒæ­¥éª¤**:

1. å‘é€æ–¹è°ƒç”¨ Token.transfer() æˆ– Token.transferFrom()
2. Token åˆçº¦éªŒè¯å‘é€æ–¹å’Œæ¥æ”¶æ–¹çš„èº«ä»½ (isVerified())
3. Token åˆçº¦è°ƒç”¨ ModularCompliance.canTransfer() æ£€æŸ¥åˆè§„
4. åˆè§„æ£€æŸ¥é€šè¿‡åæ‰§è¡Œè½¬è´¦
5. æ›´æ–°ä½™é¢å¹¶è§¦å‘ Transfer äº‹ä»¶

**è½¬è´¦å‰ç½®æ¡ä»¶**:

-   âœ… å‘é€æ–¹å’Œæ¥æ”¶æ–¹éƒ½å¿…é¡»åœ¨ IdentityRegistry ä¸­æ³¨å†Œ
-   âœ… å‘é€æ–¹å’Œæ¥æ”¶æ–¹éƒ½å¿…é¡»é€šè¿‡ isVerified() éªŒè¯
-   âœ… è½¬è´¦å¿…é¡»é€šè¿‡æ‰€æœ‰åˆè§„æ¨¡å—çš„æ£€æŸ¥
-   âœ… å‘é€æ–¹ä½™é¢å……è¶³ä¸”æœªè¢«å†»ç»“

---

### 4.2 Token åˆçº¦è¯¦è§£

**å®˜æ–¹æ¥å£** (æ¥è‡ª [EIP-3643](https://eips.ethereum.org/EIPS/eip-3643)):

```solidity
interface IERC3643 is IERC20 {
    // ERC-3643 ç‰¹æœ‰äº‹ä»¶
    event UpdatedTokenInformation(string indexed _newName, string indexed _newSymbol);
    event IdentityRegistryAdded(address indexed _identityRegistry);
    event ComplianceAdded(address indexed _compliance);
    event RecoverySuccess(address indexed _lostWallet, address indexed _newWallet, address indexed _investorOnchainID);

    // èº«ä»½å’Œåˆè§„ç®¡ç†
    function setIdentityRegistry(address _identityRegistry) external;
    function setCompliance(address _compliance) external;

    // ä»£å¸ä¿¡æ¯
    function identityRegistry() external view returns (IIdentityRegistry);
    function compliance() external view returns (IModularCompliance);
    function onchainID() external view returns (address);

    // å¼ºåˆ¶è½¬è´¦ (ä»… Agent è§’è‰²)
    function forcedTransfer(address _from, address _to, uint256 _amount) external returns (bool);

    // ä»£å¸å†»ç»“
    function setAddressFrozen(address _userAddress, bool _freeze) external;
    function freezePartialTokens(address _userAddress, uint256 _amount) external;
    function unfreezePartialTokens(address _userAddress, uint256 _amount) external;

    // æŸ¥è¯¢å†»ç»“çŠ¶æ€
    function isFrozen(address _userAddress) external view returns (bool);
    function getFrozenTokens(address _userAddress) external view returns (uint256);
}
```

**transfer() å‡½æ•°å®ç°**:

```solidity
function transfer(address _to, uint256 _amount) public override returns (bool) {
    // 1. èº«ä»½éªŒè¯
    require(identityRegistry.isVerified(msg.sender), "Sender not verified");
    require(identityRegistry.isVerified(_to), "Receiver not verified");

    // 2. å†»ç»“æ£€æŸ¥
    require(!isFrozen(msg.sender), "Sender is frozen");
    require(balanceOf(msg.sender) - getFrozenTokens(msg.sender) >= _amount, "Insufficient unfrozen balance");

    // 3. åˆè§„æ£€æŸ¥
    require(compliance.canTransfer(msg.sender, _to, _amount), "Transfer not compliant");

    // 4. æ‰§è¡Œè½¬è´¦
    _transfer(msg.sender, _to, _amount);

    // 5. æ›´æ–°åˆè§„çŠ¶æ€
    compliance.transferred(msg.sender, _to, _amount);

    return true;
}
```

---

### 4.3 ä»£ç ç¤ºä¾‹

#### 4.3.1 å®Œæ•´çš„ä»£å¸è½¬è´¦æµç¨‹ (Solidity)

```solidity
// SPDX-License-Identifier: GPL-3.0
pragma solidity ^0.8.0;

import "@erc-3643/core/contracts/token/Token.sol";

/**
 * @title TokenTransfer
 * @dev ä»£å¸è½¬è´¦å®Œæ•´æµç¨‹ç¤ºä¾‹
 */
contract TokenTransfer {
    Token public token;

    constructor(address _token) {
        token = Token(_token);
    }

    /**
     * @dev æ‰§è¡Œä»£å¸è½¬è´¦
     * @param _to æ¥æ”¶è€…åœ°å€
     * @param _amount è½¬è´¦é‡‘é¢
     */
    function executeTransfer(address _to, uint256 _amount) external {
        console.log("=== å¼€å§‹ä»£å¸è½¬è´¦ ===");
        console.log("å‘é€æ–¹:", msg.sender);
        console.log("æ¥æ”¶æ–¹:", _to);
        console.log("é‡‘é¢:", _amount);

        // 1. æ£€æŸ¥å‘é€æ–¹èº«ä»½
        IIdentityRegistry identityRegistry = token.identityRegistry();
        require(identityRegistry.isVerified(msg.sender), "å‘é€æ–¹æœªéªŒè¯");
        console.log("âœ“ å‘é€æ–¹èº«ä»½éªŒè¯é€šè¿‡");

        // 2. æ£€æŸ¥æ¥æ”¶æ–¹èº«ä»½
        require(identityRegistry.isVerified(_to), "æ¥æ”¶æ–¹æœªéªŒè¯");
        console.log("âœ“ æ¥æ”¶æ–¹èº«ä»½éªŒè¯é€šè¿‡");

        // 3. æ£€æŸ¥å‘é€æ–¹ä½™é¢
        uint256 balance = token.balanceOf(msg.sender);
        uint256 frozenTokens = token.getFrozenTokens(msg.sender);
        uint256 availableBalance = balance - frozenTokens;
        require(availableBalance >= _amount, "ä½™é¢ä¸è¶³");
        console.log("âœ“ ä½™é¢æ£€æŸ¥é€šè¿‡");
        console.log("  æ€»ä½™é¢:", balance);
        console.log("  å†»ç»“ä½™é¢:", frozenTokens);
        console.log("  å¯ç”¨ä½™é¢:", availableBalance);

        // 4. æ£€æŸ¥åˆè§„æ€§
        IModularCompliance compliance = token.compliance();
        require(compliance.canTransfer(msg.sender, _to, _amount), "ä¸ç¬¦åˆåˆè§„è¦æ±‚");
        console.log("âœ“ åˆè§„æ£€æŸ¥é€šè¿‡");

        // 5. æ‰§è¡Œè½¬è´¦
        bool success = token.transfer(_to, _amount);
        require(success, "è½¬è´¦å¤±è´¥");
        console.log("âœ“ è½¬è´¦æˆåŠŸ");

        console.log("=== ä»£å¸è½¬è´¦å®Œæˆ ===");
    }

    /**
     * @dev æ‰¹é‡è½¬è´¦
     * @param _recipients æ¥æ”¶è€…åœ°å€æ•°ç»„
     * @param _amounts è½¬è´¦é‡‘é¢æ•°ç»„
     */
    function batchTransfer(
        address[] memory _recipients,
        uint256[] memory _amounts
    ) external {
        require(_recipients.length == _amounts.length, "æ•°ç»„é•¿åº¦ä¸åŒ¹é…");

        console.log("=== å¼€å§‹æ‰¹é‡è½¬è´¦ ===");
        console.log("æ¥æ”¶è€…æ•°é‡:", _recipients.length);

        for (uint256 i = 0; i < _recipients.length; i++) {
            console.log("\nè½¬è´¦", i + 1, "/", _recipients.length);
            executeTransfer(_recipients[i], _amounts[i]);
        }

        console.log("\n=== æ‰¹é‡è½¬è´¦å®Œæˆ ===");
    }
}
```

#### 4.3.2 è°ƒç”¨ç¤ºä¾‹

```solidity
// å•ç¬”è½¬è´¦
TokenTransfer transferContract = new TokenTransfer(tokenAddress);
transferContract.executeTransfer(
    recipientAddress,
    1000 * 10**18  // 1000 ä»£å¸
);

// æ‰¹é‡è½¬è´¦
address[] memory recipients = new address[](3);
recipients[0] = address(0x123...);
recipients[1] = address(0x456...);
recipients[2] = address(0x789...);

uint256[] memory amounts = new uint256[](3);
amounts[0] = 100 * 10**18;
amounts[1] = 200 * 10**18;
amounts[2] = 300 * 10**18;

transferContract.batchTransfer(recipients, amounts);
```

---

## 5. ä¸šåŠ¡æµç¨‹ 4: åˆè§„æ£€æŸ¥ âœ… å®˜æ–¹éªŒè¯

**éªŒè¯çŠ¶æ€**: âœ… å·²å¯¹é½ ERC-3643 å®˜æ–¹æ ‡å‡†
**å®˜æ–¹æ–‡æ¡£**: [EIP-3643](https://eips.ethereum.org/EIPS/eip-3643), [ERC-3643 GitHub](https://github.com/ERC-3643/ERC-3643)

### 5.1 æµç¨‹æ¦‚è¿°

åˆè§„æ£€æŸ¥æ˜¯ ERC-3643 çš„æ ¸å¿ƒç‰¹æ€§,é€šè¿‡ Modular Compliance ç³»ç»Ÿå®ç°çµæ´»çš„åˆè§„è§„åˆ™ã€‚

**æ¶‰åŠçš„åˆçº¦**: ModularCompliance, IModule (åˆè§„æ¨¡å—æ¥å£)

**æ ¸å¿ƒæ­¥éª¤**:

1. Token åˆçº¦è°ƒç”¨ ModularCompliance.canTransfer()
2. ModularCompliance éå†æ‰€æœ‰å·²ç»‘å®šçš„åˆè§„æ¨¡å—
3. æ¯ä¸ªæ¨¡å—æ‰§è¡Œ moduleCheck() æ£€æŸ¥
4. æ‰€æœ‰æ¨¡å—éƒ½é€šè¿‡æ‰å…è®¸è½¬è´¦
5. è½¬è´¦åè°ƒç”¨ transferred() æ›´æ–°åˆè§„çŠ¶æ€

**å¸¸è§åˆè§„æ¨¡å—**:

-   **CountryRestrictionModule**: å›½å®¶é™åˆ¶ (ç¦æ­¢ç‰¹å®šå›½å®¶çš„æŠ•èµ„è€…)
-   **SupplyLimitModule**: ä¾›åº”é‡é™åˆ¶ (é™åˆ¶ä»£å¸æ€»ä¾›åº”é‡)
-   **TransferLimitModule**: è½¬è´¦é™åˆ¶ (é™åˆ¶å•ç¬”è½¬è´¦é‡‘é¢æˆ–é¢‘ç‡)
-   **MaxBalanceModule**: æŒä»“é™åˆ¶ (é™åˆ¶å•ä¸ªæŠ•èµ„è€…çš„æœ€å¤§æŒä»“)
-   **TimeTransfersLimitsModule**: æ—¶é—´é™åˆ¶ (é™åˆ¶ç‰¹å®šæ—¶é—´æ®µçš„è½¬è´¦)

---

### 5.2 Modular Compliance ç³»ç»Ÿè¯¦è§£

#### 5.2.1 æ ¸å¿ƒæ¦‚å¿µ

**Modular Compliance** æ˜¯ ERC-3643 çš„æ ¸å¿ƒåˆ›æ–°ä¹‹ä¸€:

-   **å¯æ’æ‹”**: æ”¯æŒåŠ¨æ€æ·»åŠ /ç§»é™¤åˆè§„æ¨¡å—
-   **çµæ´»æ€§**: æ¯ä¸ªä»£å¸å¯ä»¥æœ‰ä¸åŒçš„åˆè§„è§„åˆ™ç»„åˆ
-   **å¯æ‰©å±•**: å¯ä»¥å¼€å‘è‡ªå®šä¹‰åˆè§„æ¨¡å—
-   **é“¾ä¸Šæ‰§è¡Œ**: æ‰€æœ‰åˆè§„æ£€æŸ¥éƒ½åœ¨é“¾ä¸Šè‡ªåŠ¨æ‰§è¡Œ

#### 5.2.2 å®˜æ–¹æ¥å£

```solidity
interface IModularCompliance {
    // äº‹ä»¶
    event ModuleAdded(address indexed _module);
    event ModuleRemoved(address indexed _module);

    // æ·»åŠ /ç§»é™¤åˆè§„æ¨¡å—
    function addModule(address _module) external;
    function removeModule(address _module) external;

    // åˆè§„æ£€æŸ¥
    function canTransfer(address _from, address _to, uint256 _value) external view returns (bool);

    // è½¬è´¦åå›è°ƒ
    function transferred(address _from, address _to, uint256 _value) external;

    // æŸ¥è¯¢æ¨¡å—
    function getModules() external view returns (address[] memory);
    function isModuleBound(address _module) external view returns (bool);
}
```

**canTransfer() å‡½æ•°è¯¦è§£**:

```solidity
function canTransfer(
    address _from,
    address _to,
    uint256 _value
) external view returns (bool) {
    // éå†æ‰€æœ‰åˆè§„æ¨¡å—
    address[] memory modules = getModules();
    for (uint256 i = 0; i < modules.length; i++) {
        // è°ƒç”¨æ¯ä¸ªæ¨¡å—çš„ moduleCheck()
        if (!IModule(modules[i]).moduleCheck(_from, _to, _value, address(token))) {
            return false;  // ä»»ä½•ä¸€ä¸ªæ¨¡å—ä¸é€šè¿‡,è½¬è´¦å¤±è´¥
        }
    }
    return true;  // æ‰€æœ‰æ¨¡å—éƒ½é€šè¿‡
}
```

---

### 5.3 ä»£ç ç¤ºä¾‹

#### 5.3.1 å®Œæ•´çš„åˆè§„æ£€æŸ¥æµç¨‹ (Solidity)

```solidity
// SPDX-License-Identifier: GPL-3.0
pragma solidity ^0.8.0;

import "@erc-3643/core/contracts/compliance/ModularCompliance.sol";
import "@erc-3643/core/contracts/compliance/modules/CountryRestrictionModule.sol";
import "@erc-3643/core/contracts/compliance/modules/SupplyLimitModule.sol";

/**
 * @title ComplianceManagement
 * @dev åˆè§„ç®¡ç†å®Œæ•´æµç¨‹ç¤ºä¾‹
 */
contract ComplianceManagement {
    ModularCompliance public compliance;
    Token public token;

    constructor(address _compliance, address _token) {
        compliance = ModularCompliance(_compliance);
        token = Token(_token);
    }

    /**
     * @dev æ·»åŠ å›½å®¶é™åˆ¶æ¨¡å—
     * @param _restrictedCountries ç¦æ­¢çš„å›½å®¶ä»£ç æ•°ç»„
     */
    function addCountryRestriction(uint16[] memory _restrictedCountries) external {
        console.log("=== æ·»åŠ å›½å®¶é™åˆ¶æ¨¡å— ===");

        // 1. éƒ¨ç½² CountryRestrictionModule
        CountryRestrictionModule module = new CountryRestrictionModule();
        console.log("âœ“ CountryRestrictionModule å·²éƒ¨ç½²:", address(module));

        // 2. é…ç½®ç¦æ­¢çš„å›½å®¶
        for (uint256 i = 0; i < _restrictedCountries.length; i++) {
            module.addCountryRestriction(_restrictedCountries[i]);
            console.log("  ç¦æ­¢å›½å®¶:", _restrictedCountries[i]);
        }

        // 3. æ·»åŠ æ¨¡å—åˆ° Compliance
        compliance.addModule(address(module));
        console.log("âœ“ æ¨¡å—å·²æ·»åŠ åˆ° Compliance");
    }

    /**
     * @dev æ·»åŠ ä¾›åº”é‡é™åˆ¶æ¨¡å—
     * @param _maxSupply æœ€å¤§ä¾›åº”é‡
     */
    function addSupplyLimit(uint256 _maxSupply) external {
        console.log("=== æ·»åŠ ä¾›åº”é‡é™åˆ¶æ¨¡å— ===");
        console.log("æœ€å¤§ä¾›åº”é‡:", _maxSupply);

        // 1. éƒ¨ç½² SupplyLimitModule
        SupplyLimitModule module = new SupplyLimitModule();
        console.log("âœ“ SupplyLimitModule å·²éƒ¨ç½²:", address(module));

        // 2. è®¾ç½®æœ€å¤§ä¾›åº”é‡
        module.setSupplyLimit(_maxSupply);
        console.log("âœ“ æœ€å¤§ä¾›åº”é‡å·²è®¾ç½®");

        // 3. æ·»åŠ æ¨¡å—åˆ° Compliance
        compliance.addModule(address(module));
        console.log("âœ“ æ¨¡å—å·²æ·»åŠ åˆ° Compliance");
    }

    /**
     * @dev æ£€æŸ¥è½¬è´¦æ˜¯å¦åˆè§„
     * @param _from å‘é€æ–¹
     * @param _to æ¥æ”¶æ–¹
     * @param _amount é‡‘é¢
     */
    function checkCompliance(
        address _from,
        address _to,
        uint256 _amount
    ) external view returns (bool) {
        console.log("=== æ£€æŸ¥è½¬è´¦åˆè§„æ€§ ===");
        console.log("å‘é€æ–¹:", _from);
        console.log("æ¥æ”¶æ–¹:", _to);
        console.log("é‡‘é¢:", _amount);

        // è°ƒç”¨ canTransfer()
        bool canTransfer = compliance.canTransfer(_from, _to, _amount);

        if (canTransfer) {
            console.log("âœ“ åˆè§„æ£€æŸ¥é€šè¿‡");
        } else {
            console.log("âœ— åˆè§„æ£€æŸ¥å¤±è´¥");
        }

        return canTransfer;
    }

    /**
     * @dev æŸ¥è¯¢æ‰€æœ‰åˆè§„æ¨¡å—
     */
    function listModules() external view returns (address[] memory) {
        address[] memory modules = compliance.getModules();

        console.log("=== å·²ç»‘å®šçš„åˆè§„æ¨¡å— ===");
        console.log("æ¨¡å—æ•°é‡:", modules.length);

        for (uint256 i = 0; i < modules.length; i++) {
            console.log("æ¨¡å—", i + 1, ":", modules[i]);
        }

        return modules;
    }
}
```

#### 5.3.2 è°ƒç”¨ç¤ºä¾‹

```solidity
// 1. æ·»åŠ å›½å®¶é™åˆ¶ (ç¦æ­¢æœé²œå’Œä¼Šæœ—)
uint16[] memory restrictedCountries = new uint16[](2);
restrictedCountries[0] = 408;  // æœé²œ (ISO 3166-1)
restrictedCountries[1] = 364;  // ä¼Šæœ— (ISO 3166-1)
complianceManagement.addCountryRestriction(restrictedCountries);

// 2. æ·»åŠ ä¾›åº”é‡é™åˆ¶ (æœ€å¤§ 1000ä¸‡ä»£å¸)
complianceManagement.addSupplyLimit(10_000_000 * 10**18);

// 3. æ£€æŸ¥è½¬è´¦åˆè§„æ€§
bool isCompliant = complianceManagement.checkCompliance(
    senderAddress,
    recipientAddress,
    1000 * 10**18
);
```

---

## 6. ä¸šåŠ¡æµç¨‹ 5: ä»£å¸èµå› âœ… å®˜æ–¹éªŒè¯

**éªŒè¯çŠ¶æ€**: âœ… å·²å¯¹é½ ERC-3643 å®˜æ–¹æ ‡å‡†
**å®˜æ–¹æ–‡æ¡£**: [EIP-3643](https://eips.ethereum.org/EIPS/eip-3643), [ERC-3643 GitHub](https://github.com/ERC-3643/ERC-3643)

### 6.1 æµç¨‹æ¦‚è¿°

ä»£å¸èµå›æ˜¯æŠ•èµ„è€…é€€å‡ºæŠ•èµ„çš„æµç¨‹,é€šè¿‡é”€æ¯ä»£å¸æ¥å‡å°‘æ€»ä¾›åº”é‡ã€‚

**æ¶‰åŠçš„åˆçº¦**: Token (IERC3643)

**æ ¸å¿ƒæ­¥éª¤**:

1. æŠ•èµ„è€…æäº¤èµå›è¯·æ±‚ (é“¾ä¸‹æµç¨‹)
2. å‘è¡Œè€…å®¡æ ¸èµå›è¯·æ±‚
3. å‘è¡Œè€…è°ƒç”¨ Token.burn() æˆ– Token.forcedTransfer() + burn()
4. ä»£å¸è¢«é”€æ¯,æ€»ä¾›åº”é‡å‡å°‘
5. å‘è¡Œè€…å‘æŠ•èµ„è€…æ”¯ä»˜å¯¹åº”çš„åº•å±‚èµ„äº§ (é“¾ä¸‹æµç¨‹)

**èµå›æ–¹å¼**:

-   **è‡ªæ„¿èµå›**: æŠ•èµ„è€…ä¸»åŠ¨è¯·æ±‚èµå›,å‘è¡Œè€…è°ƒç”¨ burn()
-   **å¼ºåˆ¶èµå›**: å‘è¡Œè€…å¼ºåˆ¶èµå›,è°ƒç”¨ forcedTransfer() è½¬ç§»ä»£å¸å burn()

---

### 6.2 Token é”€æ¯æ¥å£

**å®˜æ–¹æ¥å£** (æ¥è‡ª [EIP-3643](https://eips.ethereum.org/EIPS/eip-3643)):

```solidity
interface IERC3643 {
    // é”€æ¯ä»£å¸
    function burn(address _userAddress, uint256 _amount) external;

    // å¼ºåˆ¶è½¬è´¦ (ç”¨äºå¼ºåˆ¶èµå›)
    function forcedTransfer(address _from, address _to, uint256 _amount) external returns (bool);

    // æ‰¹é‡é”€æ¯
    function batchBurn(address[] calldata _userAddresses, uint256[] calldata _amounts) external;
}
```

**burn() å‡½æ•°å®ç°**:

```solidity
function burn(address _userAddress, uint256 _amount) external onlyAgent {
    // 1. æ£€æŸ¥ä½™é¢
    require(balanceOf(_userAddress) >= _amount, "Insufficient balance");

    // 2. é”€æ¯ä»£å¸
    _burn(_userAddress, _amount);

    // 3. æ›´æ–°åˆè§„çŠ¶æ€
    compliance.transferred(_userAddress, address(0), _amount);

    emit Burn(_userAddress, _amount);
}
```

---

### 6.3 ä»£ç ç¤ºä¾‹

#### 6.3.1 å®Œæ•´çš„ä»£å¸èµå›æµç¨‹ (Solidity)

```solidity
// SPDX-License-Identifier: GPL-3.0
pragma solidity ^0.8.0;

import "@erc-3643/core/contracts/token/Token.sol";

/**
 * @title TokenRedemption
 * @dev ä»£å¸èµå›å®Œæ•´æµç¨‹ç¤ºä¾‹
 */
contract TokenRedemption {
    Token public token;

    // èµå›è¯·æ±‚ç»“æ„
    struct RedemptionRequest {
        address investor;
        uint256 amount;
        uint256 timestamp;
        bool approved;
        bool executed;
    }

    // èµå›è¯·æ±‚æ˜ å°„
    mapping(uint256 => RedemptionRequest) public redemptionRequests;
    uint256 public nextRequestId;

    event RedemptionRequested(uint256 indexed requestId, address indexed investor, uint256 amount);
    event RedemptionApproved(uint256 indexed requestId);
    event RedemptionExecuted(uint256 indexed requestId, address indexed investor, uint256 amount);

    constructor(address _token) {
        token = Token(_token);
    }

    /**
     * @dev æŠ•èµ„è€…æäº¤èµå›è¯·æ±‚
     * @param _amount èµå›é‡‘é¢
     */
    function requestRedemption(uint256 _amount) external returns (uint256) {
        console.log("=== æäº¤èµå›è¯·æ±‚ ===");
        console.log("æŠ•èµ„è€…:", msg.sender);
        console.log("èµå›é‡‘é¢:", _amount);

        // 1. æ£€æŸ¥ä½™é¢
        uint256 balance = token.balanceOf(msg.sender);
        require(balance >= _amount, "ä½™é¢ä¸è¶³");
        console.log("âœ“ ä½™é¢æ£€æŸ¥é€šè¿‡");

        // 2. åˆ›å»ºèµå›è¯·æ±‚
        uint256 requestId = nextRequestId++;
        redemptionRequests[requestId] = RedemptionRequest({
            investor: msg.sender,
            amount: _amount,
            timestamp: block.timestamp,
            approved: false,
            executed: false
        });

        emit RedemptionRequested(requestId, msg.sender, _amount);
        console.log("âœ“ èµå›è¯·æ±‚å·²åˆ›å»º, ID:", requestId);

        return requestId;
    }

    /**
     * @dev å‘è¡Œè€…æ‰¹å‡†èµå›è¯·æ±‚
     * @param _requestId èµå›è¯·æ±‚ ID
     */
    function approveRedemption(uint256 _requestId) external {
        console.log("=== æ‰¹å‡†èµå›è¯·æ±‚ ===");
        console.log("è¯·æ±‚ ID:", _requestId);

        RedemptionRequest storage request = redemptionRequests[_requestId];
        require(!request.approved, "è¯·æ±‚å·²æ‰¹å‡†");
        require(!request.executed, "è¯·æ±‚å·²æ‰§è¡Œ");

        request.approved = true;
        emit RedemptionApproved(_requestId);
        console.log("âœ“ èµå›è¯·æ±‚å·²æ‰¹å‡†");
    }

    /**
     * @dev æ‰§è¡Œèµå› (é”€æ¯ä»£å¸)
     * @param _requestId èµå›è¯·æ±‚ ID
     */
    function executeRedemption(uint256 _requestId) external {
        console.log("=== æ‰§è¡Œèµå› ===");
        console.log("è¯·æ±‚ ID:", _requestId);

        RedemptionRequest storage request = redemptionRequests[_requestId];
        require(request.approved, "è¯·æ±‚æœªæ‰¹å‡†");
        require(!request.executed, "è¯·æ±‚å·²æ‰§è¡Œ");

        // 1. é”€æ¯ä»£å¸
        token.burn(request.investor, request.amount);
        console.log("âœ“ ä»£å¸å·²é”€æ¯");
        console.log("  æŠ•èµ„è€…:", request.investor);
        console.log("  é”€æ¯é‡‘é¢:", request.amount);

        // 2. æ ‡è®°ä¸ºå·²æ‰§è¡Œ
        request.executed = true;
        emit RedemptionExecuted(_requestId, request.investor, request.amount);

        console.log("âœ“ èµå›æ‰§è¡Œå®Œæˆ");
    }

    /**
     * @dev å¼ºåˆ¶èµå› (ç”¨äºåˆè§„è¦æ±‚)
     * @param _investor æŠ•èµ„è€…åœ°å€
     * @param _amount èµå›é‡‘é¢
     */
    function forcedRedemption(address _investor, uint256 _amount) external {
        console.log("=== å¼ºåˆ¶èµå› ===");
        console.log("æŠ•èµ„è€…:", _investor);
        console.log("èµå›é‡‘é¢:", _amount);

        // 1. å¼ºåˆ¶è½¬è´¦åˆ°åˆçº¦åœ°å€
        token.forcedTransfer(_investor, address(this), _amount);
        console.log("âœ“ ä»£å¸å·²å¼ºåˆ¶è½¬ç§»åˆ°åˆçº¦");

        // 2. é”€æ¯ä»£å¸
        token.burn(address(this), _amount);
        console.log("âœ“ ä»£å¸å·²é”€æ¯");

        console.log("âœ“ å¼ºåˆ¶èµå›å®Œæˆ");
    }

    /**
     * @dev æ‰¹é‡èµå›
     * @param _requestIds èµå›è¯·æ±‚ ID æ•°ç»„
     */
    function batchRedemption(uint256[] memory _requestIds) external {
        console.log("=== æ‰¹é‡èµå› ===");
        console.log("è¯·æ±‚æ•°é‡:", _requestIds.length);

        for (uint256 i = 0; i < _requestIds.length; i++) {
            console.log("\næ‰§è¡Œèµå›", i + 1, "/", _requestIds.length);
            executeRedemption(_requestIds[i]);
        }

        console.log("\n=== æ‰¹é‡èµå›å®Œæˆ ===");
    }
}
```

#### 6.3.2 è°ƒç”¨ç¤ºä¾‹

```solidity
// 1. æŠ•èµ„è€…æäº¤èµå›è¯·æ±‚
uint256 requestId = redemption.requestRedemption(1000 * 10**18);

// 2. å‘è¡Œè€…æ‰¹å‡†èµå›
redemption.approveRedemption(requestId);

// 3. æ‰§è¡Œèµå› (é”€æ¯ä»£å¸)
redemption.executeRedemption(requestId);

// 4. å¼ºåˆ¶èµå› (åˆè§„è¦æ±‚)
redemption.forcedRedemption(investorAddress, 500 * 10**18);

// 5. æ‰¹é‡èµå›
uint256[] memory requestIds = new uint256[](3);
requestIds[0] = 1;
requestIds[1] = 2;
requestIds[2] = 3;
redemption.batchRedemption(requestIds);
```

---

## 7. å®Œæ•´ä¸šåŠ¡æµç¨‹å›¾

```mermaid
graph TB
    Start[å¼€å§‹] --> Deploy[1. éƒ¨ç½²ä»£å¸]
    Deploy --> KYC[2. KYCéªŒè¯]
    KYC --> Mint[3. é“¸é€ ä»£å¸]
    Mint --> Transfer[4. è½¬è´¦ä»£å¸]
    Transfer --> Compliance[5. åˆè§„æ£€æŸ¥]
    Compliance --> Burn[6. é”€æ¯ä»£å¸]
    Burn --> End[ç»“æŸ]

    style Deploy fill:#4CAF50
    style KYC fill:#2196F3
    style Compliance fill:#FF9800
    style Burn fill:#9C27B0
```

---

## 8. ERC3643 æ ‡å‡†è¯¦è§£

### 8.1 æ ¸å¿ƒæ¥å£

```solidity
interface IERC3643 {
    // èº«ä»½éªŒè¯
    function identityRegistry() external view returns (address);

    // åˆè§„æ£€æŸ¥
    function compliance() external view returns (address);

    // è½¬è´¦(å¸¦åˆè§„æ£€æŸ¥)
    function transfer(address to, uint256 amount) external returns (bool);

    // å¼ºåˆ¶è½¬è´¦(ä»…ä»£ç†)
    function forcedTransfer(address from, address to, uint256 amount) external;

    // å†»ç»“/è§£å†»
    function freeze(address account) external;
    function unfreeze(address account) external;
}
```

---

## 9. å…³é”®åˆè§„è§„åˆ™

### 9.1 å›½å®¶é™åˆ¶

```solidity
// ç¦æ­¢ç‰¹å®šå›½å®¶çš„æŠ•èµ„è€…
function addCountryRestriction(uint16 country) external;
```

### 9.2 æŠ•èµ„è€…æ•°é‡é™åˆ¶

```solidity
// é™åˆ¶æœ€å¤§æŠ•èµ„è€…æ•°é‡
function setMaxInvestors(uint256 max) external;
```

### 9.3 æŒä»“é™åˆ¶

```solidity
// é™åˆ¶å•ä¸ªæŠ•èµ„è€…æœ€å¤§æŒä»“
function setMaxBalance(uint256 max) external;
```

---

## 10. ç½‘ç»œä¿¡æ¯

### 10.1 æ”¯æŒçš„ç½‘ç»œ

-   **Ethereum Mainnet**: Chain ID 1
-   **Polygon**: Chain ID 137
-   **Avalanche C-Chain**: Chain ID 43114
-   **BSC**: Chain ID 56

---

## 11. æ€»ç»“ä¸æœ€ä½³å®è·µ

### 11.1 æ ¸å¿ƒç‰¹ç‚¹

1. **ERC3643 æ ‡å‡†**: ä¸“ä¸ºå®‰å…¨ä»£å¸è®¾è®¡
2. **æ¨¡å—åŒ–åˆè§„**: çµæ´»çš„åˆè§„è§„åˆ™
3. **é“¾ä¸Šèº«ä»½**: ONCHAINID èº«ä»½ç®¡ç†
4. **å…¨çƒéƒ¨ç½²**: æ”¯æŒå¤šé“¾

### 11.2 å¼€å‘æœ€ä½³å®è·µ

1. **ä»£å¸éƒ¨ç½²**: ä½¿ç”¨ TokenFactory ç»Ÿä¸€éƒ¨ç½²
2. **KYC ç®¡ç†**: ä½¿ç”¨å¯ä¿¡çš„ KYC æä¾›å•†
3. **åˆè§„é…ç½®**: æ ¹æ®ç›‘ç®¡è¦æ±‚é…ç½®åˆè§„æ¨¡å—
4. **Gas ä¼˜åŒ–**: ä½¿ç”¨æ‰¹é‡æ“ä½œå‡å°‘ Gas æˆæœ¬

### 11.3 å¸¸è§é—®é¢˜ FAQ

**Q: ERC3643 ä¸ ERC20 çš„åŒºåˆ«?**
A: ERC3643 åœ¨ ERC20 åŸºç¡€ä¸Šå¢åŠ äº†èº«ä»½éªŒè¯å’Œåˆè§„æ£€æŸ¥ã€‚

**Q: å¦‚ä½•æ·»åŠ æ–°çš„åˆè§„è§„åˆ™?**
A: å¼€å‘æ–°çš„ ComplianceModule å¹¶æ·»åŠ åˆ° ModularComplianceã€‚

**Q: ä»£å¸å¯ä»¥åœ¨ DEX äº¤æ˜“å—?**
A: å¯ä»¥,ä½†éœ€è¦ DEX æ”¯æŒ ERC3643 æ ‡å‡†ã€‚

---

## ğŸ“š å‚è€ƒèµ„æº

**å®˜æ–¹èµ„æº**:

-   **å®˜æ–¹ç½‘ç«™**: https://tokeny.com/
-   **å®˜æ–¹æ–‡æ¡£**: https://docs.tokeny.com/
-   **GitHub ä»“åº“**: https://github.com/TokenySolutions/T-REX
-   **T-REX Engine**: https://tokeny.com/t-rex-engine/

**æŠ€æœ¯æ ‡å‡†**:

-   **ERC3643 æ ‡å‡†**: https://eips.ethereum.org/EIPS/eip-3643
-   **ERC3643 å®˜æ–¹é¡µé¢**: https://tokeny.com/erc3643/
-   **T-REX v4 ç™½çš®ä¹¦**: https://tokeny.com/wp-content/uploads/2023/05/ERC3643-Whitepaper-T-REX-v4.pdf

---

**æ–‡æ¡£ç»“æŸ**
